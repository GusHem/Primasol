<!DOCTYPE html>
<html lang="no" class="light">
<head>
    <meta charset="UTF8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prima Portal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <!-- REMOVED old script tags for jspdf and jspdf-autotable -->

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; font-size: 16px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { transform: scale(1); } }
        @keyframes slideInUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideOutDown { from { transform: translateY(0); } to { transform: translateY(100%); } }
        .animate-fade-in-fast { animation: fadeIn 0.3s ease-out forwards; }
        .animate-fade-out-fast { animation: fadeOut 0.3s ease-out forwards; }
        .animate-fade-in-scale { animation: fadeInScale 0.5s cubic-bezier(0.215, 0.610, 0.355, 1) forwards; }
        .animate-slide-in-up { animation: slideInUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .animate-slide-out-down { animation: slideOutDown 0.4s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards; }
        .time-picker-column { scroll-snap-type: y mandatory; scroll-behavior: smooth; padding-top: calc(50% - 20px); padding-bottom: calc(50% - 20px); }
        .time-picker-column > div { scroll-snap-align: center; height: 40px; }
        
        .transition-all-smooth { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-interaction { transform-origin: center; }
        .btn-interaction:hover { transform: scale(1.03); }
        .btn-interaction:active { transform: scale(0.98); }
        .card-interaction:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07); }
        .dark .card-interaction:hover { box-shadow: 0 10px 15px -3px rgb(99 102 241 / 0.1), 0 4px 6px -4px rgb(99 102 241 / 0.1); }
        .accordion-content {
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 0;
        }
        .accordion-content.is-open {
            max-height: 2000px;
        }
        .accordion-icon {
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .accordion-icon.is-open {
            transform: rotate(180deg);
        }
        .collapsible-footer {
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease-out, padding 0.4s ease-out;
            max-height: 500px;
            opacity: 1;
        }
        .collapsible-footer.is-collapsed {
            max-height: 0;
            opacity: 0;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }
        .footer-chevron { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .footer-chevron.is-collapsed { transform: rotate(-180deg); }
        .kanban-column { min-width: 300px; }
        .dragging { opacity: 0.5; }
        .drag-over { background-color: rgba(245, 158, 11, 0.1); }
        
        /* GEMINI CANVAS STABILIZATION FIX */
        .canvas-safe {
            background-color: #ffffff !important;
            color: #000000 !important;
            border: 1px solid #e2e8f0 !important;
        }
        .dark .canvas-safe {
            background-color: #1e293b !important;
            color: #ffffff !important;
            border: 1px solid #475569 !important;
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">
    <div id="app-root"></div>

    <script type="module">
        // Enhanced Error Boundary - No Infinite Loops
        let errorCount = 0;
        let lastError = '';
        const MAX_ERRORS = 3;
        window.addEventListener('error', (e) => {
            const errorMsg = e.error?.message || e.message || 'Unknown error';
        
            // Prevent infinite loops
            if (errorMsg === lastError) {
                errorCount++;
                if (errorCount >= MAX_ERRORS) {
                    console.log('üõë Error loop detected, suppressing further errors');
                    return;
                }
            } else {
                errorCount = 1;
                lastError = errorMsg;
            }
        
            console.error('Prima Portal Error:', errorMsg);
        
            // Only show fallback on first critical error
            if (errorCount === 1 && (errorMsg.includes('is not defined') || e.message.includes('Unexpected token'))) { // FIKS: Utvidet til √• fange syntax-feil
                const appRootEl = document.getElementById('app-root');
                if (appRootEl) {
                    appRootEl.innerHTML = `
                        <div class="min-h-screen bg-slate-50 flex items-center justify-center p-4">
                            <div class="text-center max-w-md">
                                <h1 class="text-2xl font-bold text-slate-800 mb-4">Prima Portal</h1>
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                                    <p class="text-yellow-800">System laster kjernefunksjoner...</p>
                                    <p class="text-sm text-yellow-600 mt-2">Om problemet fortsetter, kontakt support.</p>
                                </div>
                                <button onclick="location.reload()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Last inn p√• nytt
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
        });

        // REPLACED old loadScripts function with initializePDFLibraries
        // PDF Dependency Chain - Canvas Compatible
        const initializePDFLibraries = async () => {
            try {
                // Step 1: Load jsPDF core first
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                    script.onload = () => {
                        // Verify jsPDF loaded correctly
                        if (window.jsPDF || (window.window && window.window.jsPDF)) {
                            console.log('‚úÖ jsPDF core loaded');
                            resolve();
                        } else {
                            reject(new Error('jsPDF not available after load'));
                        }
                    };
                    script.onerror = () => reject(new Error('Failed to load jsPDF'));
                    document.head.appendChild(script);
                });
        
                // Step 2: Wait and verify before loading plugin
                await new Promise(resolve => setTimeout(resolve, 100));
        
                // Step 3: Load autotable plugin
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js';
                    script.onload = () => {
                        console.log('‚úÖ jsPDF autotable plugin loaded');
                        resolve();
                    };
                    script.onerror = () => reject(new Error('Failed to load autotable plugin'));
                    document.head.appendChild(script);
                });
        
                console.log('‚úÖ PDF libraries fully initialized');
                return true;
            } catch (error) {
                console.warn('‚ö†Ô∏è PDF libraries failed to load:', error.message);
                // Set fallback flag
                window.PDF_UNAVAILABLE = true;
                return false;
            }
        };

        const appRoot = document.getElementById('app-root');

        const state = {
            isLoggedIn: false, isLoading: true, 
            quotes: [], 
            projects: [], // <-- 1. STATE SEPARATION: Ny suver√§n datak√§lla f√∂r projekt
            selectedQuoteId: null, activeView: 'quotes',
            filter: 'prioriterade', searchTerm: '', toast: null, showWidgets: true,
            theme: 'light',
            formData: null, openSections: { info: true, product: false, costs: false, customCosts: false, staff: false, internal: false, projectSummary: true }, // <-- NY: √ñppna Project Summary by default
            isTimePickerOpen: false, timePickerTarget: null, calendarViewDate: new Date(),
            displayLimit: 12, openCardMenu: { id: null, target: null },
            analyticsSubView: 'overview', isModalStatusOpen: false,
            modalStatusMenuTarget: null, // <-- NYTT STATE
            isConfirmModalOpen: false, quoteToSend: null,
            isDeleteConfirmModalOpen: false, quoteToDelete: null,
            simulatedEmailQuote: null, 
            isModalFooterCollapsed: false,
            productTemplates: {},
            isTemplateEditorOpen: false,
            wishlistItems: [
                { recordId: 'wish1', title: 'Integrasjon med karttjeneste', description: 'Integrer Google Maps for √• vise prosjektplassering og planlegge ruter for mont√∏rer.', votes: 18, status: 'planerad' },
                { recordId: 'wish2', title: 'Fotodokumentasjon f√∏r/etter', description: 'Mulighet for mont√∏rer √• laste opp bilder av installasjonen direkte i prosjektet.', votes: 12, status: 'under utveckling' },
                { recordId: 'wish3', title: 'Statistikk per mont√∏r', description: 'Se statistikk over hvor mange monteringer hver ansatt har fullf√∏rt.', votes: 7, status: 'id√©' },
                { recordId: 'wish4', title: 'Automatiske SMS-varsler', description: 'Send automatiske SMS til kunder dagen f√∏r montering.', votes: 5, status: 'id√©' }
            ],
            userVotes: {},
            staff: [
                { id: 'm1', name: 'Jonas Hansen', role: 'Hovedmont√∏r' },
                { id: 'm2', name: 'Stian Olsen', role: 'Mont√∏r' },
                { id: 'm3', name: 'Ingrid Larsen', role: 'Mont√∏r' },
                { id: 'm4', name: 'Marius Berg', role: 'L√¶rling' },
                { id: 's1', name: 'Lars Martinsen', role: 'Salg' },
                { id: 'p1', name: 'Kari Nordmann', role: 'Prosjektleder' }
            ],
            suppliers: [
                // --- BORTTAGNA PLATSH√ÖLLARE ---
                // { id: 'sup2', name: 'Warema', logoUrl: 'https://www.warema.com/media/company/warema-logo-stage-1920x1080.jpg', website: 'https://www.warema.com/no-NO/' },
                // { id: 'sup5', name: 'Sunshade Experts', logoUrl: 'https://placehold.co/200x100/f8fafc/94a3b8?text=Sunshade', website: 'https://sunshade-experts.com/' },
                // { id: 'sup6', name: 'Hansen Enterprise RS', logoUrl: 'https://placehold.co/200x100/f8fafc/94a3b8?text=Hansen+RS', website: '#' },
                // { id: 'sup7', name: 'Neva', logoUrl: 'https://placehold.co/200x100/f8fafc/94a3b8?text=Neva', website: '#' }
                
                // --- NYA, KORREKTA LEVERANT√ñRER BASERT P√Ö PDF-ER ---
                { id: 'sup_neva', name: 'Neva', logoUrl: 'https://placehold.co/200x100/f1f5f9/94a3b8?text=NEVA', website: '#' },
                { id: 'sup_hansen', name: 'Hansen Enterprise AS', logoUrl: 'https://placehold.co/200x100/f1f5f9/94a3b8?text=Hansen', website: 'https://sunshade-experts.com/' },
                { id: 'sup_somfy', name: 'Somfy', logoUrl: 'https://placehold.co/200x100/f1f5f9/94a3b8?text=Somfy', website: '#' },
                { id: 'sup_faher', name: 'Faher', logoUrl: 'https://placehold.co/200x100/f1f5f9/94a3b8?text=Faher', website: '#' },
                { id: 'sup_sunshade', name: 'Sunshade Experts', logoUrl: 'https://placehold.co/200x100/f1f5f9/94a3b8?text=Sunshade', website: 'https://sunshade-experts.com/' }
            ],
            products: [
                // --- BORTTAGNA PLATSH√ÖLLARE ('GHOST DATA') ---
                // { id: 'prod1', name: 'Markise 5000', supplierId: 'sup3', category: 'Terrassemarkiser', description: 'Premium terrassemarkise med motor.' },
                // { id: 'prod2', name: 'Pergola P40', supplierId: 'sup2', category: 'Pergola', description: 'Robust pergola med lamelltak.' },
                // { id: 'prod3', name: 'Screen 85', supplierId: 'sup4', category: 'Vindusmarkiser', description: 'Utvendig screen for vinduer.' },
                // { id: 'prod4', name: 'Solis RTS Motor', supplierId: 'sup1', category: 'Motor & Styring', description: 'Motor for markiser med fjernkontroll.' },
                // { id: 'prod5', name: 'Markise 3000', supplierId: 'sup3', category: 'Terrassemarkiser', description: 'Standard terrassemarkise med sveiv.' }
                
                // --- NY PRODUKTDATABAS BASERAD P√Ö 'OLE ERIKS LISTA' ---
                // K√ÑRNPRODUKTER
                { id: 'neva_c80_f80', name: 'NEVA C80/F80', supplierId: 'sup_neva', category: 'Utvendig Persienne', description: 'Utvendig persienne med 80mm C- eller F-lameller.' },
                { id: 'hansen_rs_classic', name: 'Hansen RS Classic', supplierId: 'sup_hansen', category: 'Screen', description: 'Klassisk screen-system. Tilgjengelig i 75, 85, 95, 105, 120, 125mm kassetter.' },
                { id: 'hansen_rs_universal', name: 'Hansen RS Universal', supplierId: 'sup_hansen', category: 'Screen', description: 'Fleksibelt screen-system med todelt styreskinne. Ogs√• for PVC-film.' },
                
                // SPECIFIKA PRODUKTER FR√ÖN LISTAN
                { id: 'hansen_screen_95', name: 'Screen 95', supplierId: 'sup_hansen', category: 'Screen', description: 'Mest popul√¶re st√∏rrelse for boliger.' },
                { id: 'hansen_screen_105', name: 'Screen 105', supplierId: 'sup_hansen', category: 'Screen', description: 'For kommersielle applikasjoner.' },
                { id: 'hansen_screen_120_125', name: 'Screen 120/125', supplierId: 'sup_hansen', category: 'Screen', description: 'For store installasjoner.' },
                
                { id: 'hansen_rs_smart_85', name: 'RS Smart 85', supplierId: 'sup_hansen', category: 'Screen (Smart)', description: 'Kompakt "smart" screen-l√∏sning.' },
                { id: 'hansen_rs_smart_100', name: 'RS Smart 100', supplierId: 'sup_hansen', category: 'Screen (Smart)', description: 'Medium "smart" screen-l√∏sning.' },
                { id: 'hansen_rs_smart_130', name: 'RS Smart 130', supplierId: 'sup_hansen', category: 'Screen (Smart)', description: 'Stor "smart" screen-l√∏sning.' },

                // MOTORER
                { id: 'somfy_io_6nm', name: 'Somfy io Motor (6Nm)', supplierId: 'sup_somfy', category: 'Motor', description: 'Motor med io-styring, 6Nm. Pris ca 5,804 NOK.' },
                { id: 'somfy_io_10nm', name: 'Somfy io Motor (10Nm)', supplierId: 'sup_somfy', category: 'Motor', description: 'Motor med io-styring, 10Nm.' },
                { id: 'somfy_io_20nm', name: 'Somfy io Motor (20Nm)', supplierId: 'sup_somfy', category: 'Motor', description: 'Motor med io-styring, 20Nm. Pris ca 9,069 NOK.' },
                { id: 'faher_solar', name: 'Faher Solar Motor', supplierId: 'sup_faher', category: 'Motor', description: 'Batteridrevet solcellemotor. Pris ca 3,400-3,700 NOK.' },

                // DUKAR (som produkter)
                { id: 'fabric_soltis_86_88_92', name: 'Duk: Soltis 86/88/92', supplierId: 'sup_sunshade', category: 'Duk', description: 'Standard duk, ingen pristillegg.' },
                { id: 'fabric_serge_ferrari', name: 'Duk: Serge Ferrari', supplierId: 'sup_sunshade', category: 'Duk', description: 'Standard duk, ingen pristillegg.' },
                { id: 'fabric_mermet_satine_5500', name: 'Duk: Mermet Satine 5500', supplierId: 'sup_sunshade', category: 'Duk', description: 'Standard duk, ingen pristillegg.' },
                { id: 'fabric_blackout', name: 'Duk: Blackout', supplierId: 'sup_sunshade', category: 'Duk', description: 'M√∏rkleggingsduk. +25% pristillegg.' }
            ],
            timeReports: [
                { id: 'tr1', staffId: 'm1', projectId: 'PS-1672786800000', date: '2025-09-12', hours: 8, description: 'Montering av pergola.' },
                { id: 'tr2', staffId: 'm2', projectId: 'PS-1672786800000', date: '2025-09-12', hours: 8, description: 'Assisterte p√• pergola-montering.' },
                { id: 'tr3', staffId: 'm1', projectId: 'PS-1672959600000', date: '2025-09-05', hours: 6, description: 'Montering av markise p√• hytte.' }
            ],
            socialPosts: [
                { id: 'sp1', staffId: 'm1', timestamp: '2025-09-12T16:30:00Z', content: 'Ferdig med pergolaen hos familien Pettersen! Ble utrolig bra. ‚òÄÔ∏è', imageUrl: 'https://images.unsplash.com/photo-1614059032829-17b010c7329b?q=80&w=2070' },
                { id: 'sp2', staffId: 'm3', timestamp: '2025-09-10T12:00:00Z', content: 'Ny uke, nye monteringer! Klar for √• gi skygge til folket.', imageUrl: 'https://images.unsplash.com/photo-1595184893693-5975b31d4e13?q=80&w=1974' }
            ],
            // --- NY KONSTANT F√ñR STATUSF√ÑRGER ---
            statusColors: {
                nytt: { name: 'Nytt', bg: 'bg-blue-100 dark:bg-blue-900/60', text: 'text-blue-700 dark:text-blue-300' },
                planlagt: { name: 'Planlagt', bg: 'bg-yellow-100 dark:bg-yellow-900/60', text: 'text-yellow-700 dark:text-yellow-300' },
                p√•g√•r: { name: 'P√•g√•r', bg: 'bg-indigo-100 dark:bg-indigo-900/60', text: 'text-indigo-700 dark:text-indigo-300' },
                fullf√∏rt: { name: 'Fullf√∏rt', bg: 'bg-green-100 dark:bg-green-900/60', text: 'text-green-700 dark:text-green-300' },
                default: { name: 'Ny Status', bg: 'bg-slate-200 dark:bg-slate-700', text: 'text-slate-700 dark:text-slate-300' }
            },
            // NY STATE FOR PRODUKT- OG PROSJEKTSTYRING
            productToEdit: null,
            isDeleteProductConfirmOpen: false,
            productToDelete: null,
            projectStatuses: { 
                nytt: { name: 'Nytt', bg: 'bg-blue-100 dark:bg-blue-900/60', text: 'text-blue-700 dark:text-blue-300', order: 1 }, // <-- order
                planlagt: { name: 'Planlagt', bg: 'bg-yellow-100 dark:bg-yellow-900/60', text: 'text-yellow-700 dark:text-yellow-300', order: 2 }, // <-- order
                p√•g√•r: { name: 'P√•g√•r', bg: 'bg-indigo-100 dark:bg-indigo-900/60', text: 'text-indigo-700 dark:text-indigo-300', order: 3 }, // <-- order
                fullf√∏rt: { name: 'Fullf√∏rt', bg: 'bg-green-100 dark:bg-green-900/60', text: 'text-green-700 dark:text-green-300', order: 4 } // <-- order
            },
            isAddingColumn: false,
            isNavCollapsed: false, // <-- NYTT STATE F√ñR MENYN
            // --- START SURGICAL MODIFICATION 1 (State) ---
            selectedProjectId: null, // <-- NYTT STATE F√ñR PROSJEKT-MODAL
            isEditingColumn: null, // <-- NYTT STATE F√ñR KOLONN-REDIGERING
            // --- END SURGICAL MODIFICATION 1 ---
            // --- NYTT STATE F√ñR ANSATTE-MODAL ---
            staffToEdit: null,
            isDeleteStaffConfirmOpen: false,
        }; // <-- **FIKS: La til manglende '}' for √• lukke state-objektet.**
        
        // --- START NYTT STATE F√ñR PRODUKTFILTER ---
        state.productSearchTerm = '';
        state.productSupplierFilter = 'all';
        // --- SLUTT NYTT STATE ---

        const texts = { sv: { 'login.welcome': 'Velkommen til Prima Portalen', 
            // --- ENDRING ---
            'modal.edit_title': 'Rediger Tilbud', 
            'modal.create_title': 'Opprett Nytt Tilbud', 
            // --- SLUTT ENDRING ---
            'toast.product_saved': 'Produkt lagret!', 'toast.product_deleted': 'Produktet er slettet.', 'projects.subtitle': 'Dra og slipp prosjekter mellom statuser.',

            // --- START KIRURGISK OPPRYDDING: Legg til manglende oversettelser ---
            'nav.quotes': 'Tilbud',
            'nav.projects': 'Prosjekter',
            'nav.calendar': 'Kalender',
            'nav.products': 'Produkter',
            'nav.suppliers': 'Leverand√∏rer',
            'nav.time_reporting': 'Tidsrapportering',
            'nav.socials': 'Sosialt',
            'nav.analytics': 'Analyse',
            'nav.wishlist': '√ònskeliste',
            'nav.staff': 'Ansatte',
            
            'filter.prioriterade': 'Prioriterte',
            'filter.aktiva': 'Aktive',
            'filter.kommande': 'Kommende',
            'filter.alla': 'Alle',
            
            'status.utkast': 'Utkast',
            'status.f√∂rslag-skickat': 'Tilbud Sendt',
            'status.godk√§nd': 'Godkjent',
            'status.genomf√∂rd': 'Gjennomf√∏rt',
            'status.betald': 'Betalt',
            'status.f√∂rlorad': 'Tapt',
            'status.arkiverad': 'Arkivert',
            
            'toast.deleted': 'Slettet!',
            'toast.delete_failed': 'Sletting feilet.',
            'toast.copied': 'Kopiert!',
            'toast.fortnox_sent': 'Sendt til Fortnox (simulert).',
            'toast.templates_saved': 'Maler lagret!',
            'toast.saved': 'Tilbud lagret!', // Generisk
            
            'controls.new_quote': 'Nytt Tilbud'
            // --- SLUTT KIRURGISK OPPRYDDING ---
            
            } }; // <-- NY TEKST
        const t = (key, vars = {}) => (texts.sv[key] || key).replace(/{(\w+)}/g, (_, k) => vars[k] || `{${k}}`);
        
        // --- FIKS: Gjenopprettet manglende setState-funksjon ---
        function setState(newState, options = { render: true }) {
            // Sl√• sammen state
            Object.keys(newState).forEach(key => {
                // Enkel sammensl√•ing for nestede objekter (som formData, openSections)
                // Unng√• √• sl√• sammen null-verdier eller arrays
                if (typeof newState[key] === 'object' && newState[key] !== null && !Array.isArray(newState[key]) && state[key] && typeof state[key] === 'object' && !Array.isArray(state[key])) {
                    state[key] = { ...state[key], ...newState[key] };
                } else {
                    state[key] = newState[key];
                }
            });

            if (options.render) {
                // Bruk requestAnimationFrame for √• unng√• un√∏dvendige re-renders
                // og for √• sikre at DOM er klar
                requestAnimationFrame(() => {
                    try {
                        renderApp();
                    } catch (e) {
                        console.error('Feil under re-rendering:', e);
                        // Implementer en mer robust feilh√•ndtering her om n√∏dvendig
                    }
                });
            }
        }
        // --- SLUTT FIKS ---
        
        // --- START SURGICAL MODIFICATION 2: Add Column Editor Modal ---
        // Erstatt den eksisterende placeholder-funksjonen med denne nye, utvidede versjonen.
        function renderProjectDetailModal() {
            if (!state.selectedProjectId) return;
            
            const theme = themes[state.theme];
            const project = state.projects.find(p => p.projectId === state.selectedProjectId);
            
            if (!project) {
                console.error("Prosjektmodal kunne ikke finne prosjekt:", state.selectedProjectId);
                setState({ selectedProjectId: null });
                return;
            }

            const closeModal = () => {
                const modal = document.getElementById('project-detail-modal');
                if (modal) {
                    modal.classList.remove('animate-fade-in-fast');
                    modal.classList.add('animate-fade-out-fast');
                    // Gjenopprett den gamle skaleringsanimasjonen for en st√∏rre modal
                    modal.querySelector('div > div').classList.remove('animate-fade-in-scale'); 
                    modal.addEventListener('animationend', () => setState({ selectedProjectId: null }), { once: true });
                } else {
                    setState({ selectedProjectId: null });
                }
            };

            // --- NYTT MODAL-INNHOLD ---
            const modalContent = createElement('div', {
                className: `w-full max-w-5xl ${theme.cardBg} rounded-xl shadow-2xl animate-fade-in-scale flex flex-col h-[90vh]`, // St√∏rre modal
                onclick: e => e.stopPropagation()
            });

            // Header
            const header = createElement('header', { className: `flex-shrink-0 p-4 border-b ${theme.border} flex justify-between items-center` },
                createElement('h3', { className: `font-bold text-lg` }, `Prosjekt: ${project.customerName}`),
                createElement('button', {
                    className: `p-2 ${theme.buttonSecondaryBg} rounded-lg transition-all-smooth btn-interaction`,
                    innerHTML: icons.x('w-5 h-5'),
                    onclick: closeModal
                })
            );

            // Hent alle tilbud knyttet til dette prosjektet
            const relatedQuotes = state.quotes.filter(q => q.projectId === project.projectId);

            // --- Sidebar (H√∏yre kolonne) ---
            const sidebar = createElement('aside', { className: `md:w-72 lg:w-80 flex-shrink-0 ${theme.bg} border-l ${theme.border} p-4 space-y-4` });
            
            // Status-boks
            const statusBox = createElement('div', { className: 'space-y-2' });
            statusBox.append(createElement('label', { className: `text-xs font-semibold uppercase ${theme.textSecondary}` }, 'Status'));
            const statusSelect = createElement('select', { 
                className: `w-full p-2 rounded-lg border ${theme.border} ${theme.inputBg}`,
                onchange: (e) => {
                    const newStatus = e.target.value;
                    const updatedProjects = state.projects.map(p => 
                        p.projectId === project.projectId ? { ...p, projectStatus: newStatus } : p
                    );
                    setState({ projects: updatedProjects });
                    // TODO: Lagre endring til backend
                }
            });
            Object.entries(state.projectStatuses).forEach(([key, obj]) => {
                statusSelect.append(createElement('option', { value: key, selected: project.projectStatus === key }, obj.name));
            });
            statusBox.append(statusSelect);
            
            // Info-boks
            const infoBox = createElement('div', { className: 'space-y-2' });
            infoBox.append(createElement('label', { className: `text-xs font-semibold uppercase ${theme.textSecondary}` }, 'Detaljer'));
            infoBox.append(
                createElement('div', { className: `p-3 rounded-lg ${theme.inputBg}` },
                    createElement('p', { className: 'font-semibold' }, project.customerName),
                    createElement('p', { className: `text-sm ${theme.textSecondary}` }, project.address)
                )
            );
            
            // TODO: Legg til mont√∏rer, datoer etc. her
            sidebar.append(statusBox, infoBox);

            // --- Main Content (Venstre kolonne) ---
            const mainContent = createElement('main', { className: 'flex-grow p-6 space-y-6 overflow-y-auto' });
            
            // Seksjon for tilknyttede tilbud
            const quotesSection = createElement('section');
            quotesSection.append(createElement('h4', { className: 'text-lg font-semibold mb-3' }, 'Tilknyttede Tilbud'));
            
            const quotesList = createElement('div', { className: 'space-y-3' });
            if (relatedQuotes.length > 0) {
                relatedQuotes.forEach(q => {
                    const pillStyle = getStatusPillStyles(q.status, theme);
                    const card = createElement('div', {
                        className: `flex items-center justify-between p-4 rounded-lg border ${theme.border} ${theme.cardBg} cursor-pointer hover:${theme.buttonSecondaryHover}`,
                        title: `√Öpne tilbud ${q.id}`,
                        onclick: () => {
                            // Lukk prosjektmodalen OG √•pne tilbudsmodalen
                            setState({ selectedProjectId: null, selectedQuoteId: q.id, formData: { ...q } });
                        }
                    },
                    createElement('div', { className: 'flex-grow' },
                        createElement('p', { className: 'font-semibold' }, q.emne || 'Standardtilbud'),
                        createElement('p', { className: `text-sm ${theme.textSecondary}` }, `Total: ${q.total.toLocaleString('no-NO')} kr`)
                    ),
                    createElement('span', { className: `px-3 py-0.5 rounded-full text-xs font-semibold ${pillStyle}` }, t(`status.${q.status}`))
                    );
                    quotesList.append(card);
                });
            } else {
                quotesList.append(createElement('p', { className: `${theme.textSecondary}` }, 'Ingen tilbud er knyttet til dette prosjektet enn√•.'));
            }
            quotesSection.append(quotesList);

            // Placeholder for Sjekkliste
            const checklistSection = createElement('section');
            checklistSection.append(createElement('h4', { className: 'text-lg font-semibold mb-3' }, 'Sjekkliste (Kommer)'));
            checklistSection.append(createElement('div', { className: `p-6 rounded-lg border ${theme.border} ${theme.inputBg} text-center ${theme.textSecondary}` }, 'Funksjonalitet for prosjekt-sjekklister er under utvikling.'));

            mainContent.append(quotesSection, checklistSection);

            // Sett sammen modalen
            modalContent.append(
                header,
                createElement('div', { className: 'flex-grow flex flex-col md:flex-row overflow-hidden' },
                    mainContent,
                    sidebar
                )
            );

            return createElement('div', {
                id: 'project-detail-modal',
                className: `fixed inset-0 z-40 ${theme.modalOverlay} animate-fade-in-fast flex items-center justify-center p-4`,
                onclick: closeModal
            }, modalContent);
        }
        // --- END SURGICAL MODIFICATION ---

        // --- START NY FUNKSJON FOR KOLONN-REDIGERING ---
        function renderProjectColumnEditorModal() {
            if (!state.isEditingColumn) return;

            const theme = themes[state.theme];
            const columnKey = state.isEditingColumn;
            const columnData = state.projectStatuses[columnKey];

            if (!columnData) {
                console.error("Kolonne-editor fant ikke data for:", columnKey);
                setState({ isEditingColumn: null });
                return;
            }
            
            // Bruk en lokal kopi for √• h√•ndtere endringer i skjemaet
            let formData = { ...columnData };

            const closeModal = () => setState({ isEditingColumn: null });

            const handleSave = () => {
                // Oppdater state
                const updatedStatuses = { ...state.projectStatuses };
                updatedStatuses[columnKey] = formData;
                
                setState({ projectStatuses: updatedStatuses, isEditingColumn: null });
                showToast('Kolonne oppdatert!', 'success');
            };
            
            const handleDelete = () => {
                // Sikkerhetssjekk: Er det prosjekter i denne kolonnen?
                const projectsInColumn = state.projects.some(p => p.projectStatus === columnKey);
                if (projectsInColumn) {
                    showToast('Kan ikke slette en kolonne som inneholder prosjekter.', 'error');
                    return;
                }
                
                // Fortsett med sletting
                const updatedStatuses = { ...state.projectStatuses };
                delete updatedStatuses[columnKey];
                
                setState({ projectStatuses: updatedStatuses, isEditingColumn: null });
                showToast('Kolonne slettet!', 'success');
            };

            return createElement('div', {
                className: `fixed inset-0 z-50 ${theme.modalOverlay} animate-fade-in-fast flex items-center justify-center p-4`,
                onclick: closeModal
            }, createElement('div', {
                className: `w-full max-w-md ${theme.cardBg} rounded-xl shadow-2xl animate-fade-in-scale`,
                onclick: e => e.stopPropagation()
            },
                createElement('h3', { className: `p-4 border-b ${theme.border} font-bold text-lg` }, `Rediger Kolonne: ${columnData.name}`),
                createElement('div', { className: 'p-6 space-y-4' },
                    createElement('div', {},
                        createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Kolonnenavn'),
                        createElement('input', { 
                            type: 'text', 
                            value: formData.name, 
                            className: `w-full p-3 rounded-lg border ${theme.border} ${theme.inputBg}`,
                            oninput: (e) => formData.name = e.target.value
                        })
                    ),
                    createElement('div', {},
                        createElement('label', { className: 'block text-sm font-medium mb-1' }, 'Rekkef√∏lge (lavere tall f√∏rst)'),
                        createElement('input', { 
                            type: 'number', 
                            value: formData.order, 
                            className: `w-full p-3 rounded-lg border ${theme.border} ${theme.inputBg}`,
                            oninput: (e) => formData.order = Number(e.target.value)
                        })
                    )
                ),
                createElement('footer', { className: `p-4 rounded-b-xl ${theme.bg} border-t ${theme.border} flex justify-between gap-2`},
                    createElement('button', {
                        className: `px-4 py-2 rounded-lg bg-red-100 text-red-700 hover:bg-red-200 dark:bg-red-900/50 dark:text-red-300 dark:hover:bg-red-900/80 font-semibold`,
                        onclick: handleDelete
                    }, 'Slett Kolonne'),
                    createElement('div', { className: 'flex gap-2' },
                        createElement('button', {
                            className: `px-4 py-2 rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover} ${theme.text} font-semibold`,
                            onclick: closeModal
                        }, 'Avbryt'),
                        createElement('button', {
                            className: `px-4 py-2 rounded-lg ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText} ${theme.buttonPrimaryHover} font-semibold`,
                            onclick: handleSave
                        }, 'Lagre')
                    )
                )
            ));
        }
        // --- SLUTT NY FUNKSJON ---

        const defaultProductTemplates = {
            'TERRASSEMARKISER': {
                'Modell 5000 - Premium': "Terrassemarkise med motor og fjernkontroll. M√•l: 5m x 3m. Duk: Gr√• (RAL 7016). Inkluderer vindsensor.",
                'Modell 3000 - Standard': "Terrassemarkise med sveiv. M√•l: 4m x 2.5m. Duk: Beige. Veggfester inkludert.",
            },
            'VINDUSMARKISER': {
                'Vertikalmarkise 85': "Screen-duk for optimal sikt og solskjerming. Farge: Svart. Manuell betjening.",
                'Fasade Screen 120': "Motorisert screen-markise for store vindusflater. Inkluderer sol- og vindsensor.",
            },
            'PERGOLA': {
                'Pergola med lamelltak': "Motorisert lamelltak i aluminium, kan √•pnes og lukkes. Integrert LED-belysning. Farge: Antrasittgr√•.",
            }
        };

        const N8N_BASE_URL = 'https://nordsym.app.n8n.cloud/webhook/';
        const N8N_ENDPOINTS = { SAVE_QUOTE: 'guldkant-offer-intake-v2', GET_QUOTES: 'quotes', SEND_PROPOSAL: 'quote/dispatch', DELETE_QUOTE: 'quote/delete' };
        
        function getPlaceholderQuotes() {
            return [
                // Project 1 (Shared)
                { id: 'PS-1672614000000', recordId: 'rec002', status: 'f√∂rslag-skickat', projectStatus: 'nytt', customer: 'Hansen Bygg AS', contactPerson: 'Erik Hansen', contactEmail: 'erik@hansenbygg.no', address: 'Industriveien 2, Oslo', productCount: 2, installationDate: '2025-11-28', productUnitCost: 25000, productDescription: 'Terrassemarkise Modell 5000, 5x3m, gr√• duk.', total: 58240, assignedStaff: ['m1', 'm3'], projectId: 'PJ-2025-HANSEN', emne: 'Terrassemarkise Industriveien' }, // <-- NYTT: emne lagt til
                { id: 'PS-1672700400000', recordId: 'rec003', status: 'utkast', projectStatus: 'nytt', customer: 'Hansen Bygg AS', contactPerson: 'Erik Hansen', contactEmail: 'erik@hansenbygg.no', address: 'Strandgaten 5, Bergen (Alternativ)', productCount: 5, installationDate: '2025-11-15', productUnitCost: 8000, productDescription: '5 stk Vertikalmarkise 85 (Budget).', total: 49280, assignedStaff: [], projectId: 'PJ-2025-HANSEN', emne: 'Vindusmarkiser Bergen (Budsjett)' }, // <-- NYTT: emne lagt til
                
                // --- DATA REFACTORING: Tydligare projektgruppering ---
                // Project 2 (Pettersen)
                { id: 'PS-1672786800000', recordId: 'rec004', status: 'betald', projectStatus: 'fullf√∏rt', customer: 'Familien Pettersen', contactPerson: 'Sofia Pettersen', contactEmail: 'sofia.p@mail.no', address: 'Utsiktsveien 12, Stavanger', productCount: 1, installationDate: '2025-09-12', productUnitCost: 75000, productDescription: 'Pergola med lamelltak, 4x4m, inkludert LED.', total: 95200, assignedStaff: ['m1', 'm2', 'm3'], projectId: 'PJ-2025-PETTERSEN', emne: 'Pergola Stavanger' }, // <-- NYTT: emne lagt til
                
                // Project 3 (Kommune)
                { id: 'PS-1672873200000', recordId: 'rec005', status: 'f√∂rlorad', projectStatus: 'nytt', customer: 'Trondheim Kommune', contactPerson: 'Anders Persson', contactEmail: 'anders.p@kommunen.no', address: 'R√•dhuset, Trondheim', productCount: 10, installationDate: '2025-11-01', productUnitCost: 7500, productDescription: 'Vindusmarkiser for skole.', total: 92400, assignedStaff: [], projectId: 'PJ-2025-KOMMUNE', emne: 'Vindusmarkiser Skole' }, // <-- NYTT: emne lagt til
                
                // Project 4 (Fjellhytta)
                { id: 'PS-1672959600000', recordId: 'rec006', status: 'betald', projectStatus: 'fullf√∏rt', customer: 'Fjellhytta AS', contactPerson: 'Eva Berg', contactEmail: 'eva.berg@hytte.no', address: 'Geilovegen 1, Geilo', productCount: 1, installationDate: '2025-09-05', productUnitCost: 32000, productDescription: 'Robust terrassemarkise for v√¶rutsatt hytte.', total: 39760, assignedStaff: ['m1'], projectId: 'PJ-2025-FJELLHYTTA', emne: 'Markise Fjellhytte' }, // <-- NYTT: emne lagt til
                
                // Project 5 (Nybygg - Delat)
                { id: 'PS-1673046000000', recordId: 'rec007', status: 'utkast', projectStatus: 'nytt', customer: 'Innovate AS', contactPerson: 'Johan Lundgren', contactEmail: 'johan.l@foretag.no', address: 'Teknologiparken 8, Oslo', productCount: 3, installationDate: '2025-09-25', productUnitCost: 12000, productDescription: '3 stk Fasade Screen 120.', total: 44800, assignedStaff: ['m4'], projectId: 'PJ-2025-NYBYGG', emne: 'Screens Nybygg Oslo' }, // <-- NYTT: emne lagt til
                { id: 'PS-1673218800000', recordId: 'rec009', status: 'f√∂rslag-skickat', projectStatus: 'nytt', customer: 'Arkitektkontoret AS', contactPerson: 'Stina Jansson', contactEmail: 'prosjekt@arkitekt.no', address: 'Byporten, Hamar', productCount: 8, installationDate: '2025-11-10', productUnitCost: 9000, productDescription: 'Diverse vindusmarkiser for nybygg.', total: 88480, assignedStaff: [], projectId: 'PJ-2025-NYBYGG', emne: 'Vindusmarkiser Nybygg Hamar' }, // <-- NYTT: emne lagt til
                
                // Project 6 (Privat - Delat)
                { id: 'PS-1673132400000', recordId: 'rec008', status: 'godk√§nd', projectStatus: 'planlagt', customer: 'Familien Nilsen', contactPerson: 'Anna Nilsen', contactEmail: 'nilsen@mail.com', address: 'Hjemmeveien 12, Kristiansand', productCount: 1, installationDate: '2025-11-02', productUnitCost: 28000, productDescription: 'Terrassemarkise Modell 3000.', total: 35280, assignedStaff: ['m1', 'm3'], projectId: 'PJ-2025-PRIVAT', emne: 'Markise Kristiansand' }, // <-- NYTT: emne lagt til
                { id: 'PS-1673305200000', recordId: 'rec010', status: 'godk√§nd', projectStatus: 'p√•g√•r', customer: 'Lina Andersson', contactPerson: 'Lina Andersson', contactEmail: 'lina.a@live.no', address: 'Leiligheten p√• toppen, Troms√∏', productCount: 1, installationDate: '2025-09-28', productUnitCost: 15000, productDescription: 'Balkongmarkise', total: 20720, assignedStaff: ['m2'], projectId: 'PJ-2025-PRIVAT', emne: 'Balkongmarkise Troms√∏' }, // <-- NYTT: emne lagt til
                // --- SLUTT DATA REFACTORING ---
            ].map(q => ({...q, projectId: q.projectId, customCosts:[], internalComment: '', customerRequests: '', installationEndDate: q.installationDate, linkedProducts: [], sentDate: null, approvedDate: null, emne: q.emne || 'Standardtilbud' })); // <-- MODIFIED installationEndTime -> installationEndDate (og satt til q.installationDate som default)
        }

        class DataService {
            async _post(endpoint, data) {
                try {
                    const response = await fetch(`${N8N_BASE_URL}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    const text = await response.text();
                    const jsonResponse = text ? JSON.parse(text) : {};

                    if (!response.ok) {
                        if (jsonResponse && jsonResponse.error) {
                            throw new Error(jsonResponse.error);
                        }
                        throw new Error(`N8N Error: ${response.statusText}`);
                    }
                    return jsonResponse;
                } catch (e) {
                    if (e instanceof TypeError && e.message === 'Failed to fetch') {
                         throw new Error('NetworkError');
                    }
                    throw e;
                }
            }
            async getQuotes() { return Promise.resolve(getPlaceholderQuotes()); }
            async saveQuote(d) {
                console.log("Sparar (simulerat):", d);
                // Simulering: Uppdaterar bara det lokala state-objektet
                const quotes = state.quotes.map(q => q.id === d.offertId ? transformN8nQuoteToPortalQuote({...d, recordId: d.recordId || `rec${Date.now()}`}) : q);
                if (!quotes.find(q => q.id === d.offertId)) {
                     quotes.push(transformN8nQuoteToPortalQuote({...d, recordId: `rec${Date.now()}`}));
                }
                setState({ quotes }, {render: false});
                return Promise.resolve({ recordId: d.recordId || `rec${Date.now()}` });
            }
            async sendProposal(payload) { console.log("Skickar f√∂rslag (simulerat):", payload); return this._post(N8N_ENDPOINTS.SEND_PROPOSAL, payload); }
            async deleteQuote(recordId) {
                console.log("Raderar (simulerat):", recordId);
                const quotes = state.quotes.filter(q => q.recordId !== recordId);
                setState({ quotes }, {render: false});
                return Promise.resolve({ success: true });
            }
            
        }

        function safeJsonParse(jsonString, defaultValue) {
            if (jsonString === null || jsonString === undefined) return defaultValue;
            if (typeof jsonString === 'object') return jsonString;
            if (typeof jsonString !== 'string' || !jsonString.trim()) return defaultValue;
            try {
                const parsed = JSON.parse(jsonString);
                return parsed !== null ? parsed : defaultValue;
            } catch (e) {
                console.warn("JSON Parse Warning:", jsonString, e);
                return defaultValue;
            }
        }

        function normalizeStatus(statusString) {
            if (!statusString || typeof statusString !== 'string') return 'utkast';
            const normalized = statusString.toLowerCase().trim().replace(/\s+/g, '-');
            const statusMap = {
                'skickad': 'f√∂rslag-skickat',
                'tilbud-sendt': 'f√∂rslag-skickat',
                'f√∂rslag-skickat': 'f√∂rslag-skickat',
                'godk√§nd': 'godk√§nd',
                'godkjent': 'godk√§nd',
                'accepterad': 'godk√§nd',
                'genomf√∂rd': 'genomf√∂rd',
                'montert': 'genomf√∂rd',
                'betald': 'betald',
                'betalt': 'betald',
                'f√∂rlorad': 'f√∂rlorad',
                'tapt': 'f√∂rlorad',
                'tapt-salg': 'f√∂rlorad',
                'nekad': 'f√∂rlorad',
                'f√∂rlorad-aff√§r': 'f√∂rlorad',
                'arkiverad': 'arkiverad',
                'utkast': 'utkast'
            };
            return statusMap[normalized] || 'utkast';
        }

        function transformN8nQuoteToPortalQuote(n8nQuote) {
            const recordId = n8nQuote.recordId || n8nQuote.recordID || null;

            const quoteObject = {
                id: n8nQuote.offertId || n8nQuote.tilbudsId || n8nQuote.id || `PS-${Date.now()}`,
                projectId: n8nQuote.projectId || `PJ-${Date.now()}`, // <-- NYTT F√ÑLT
                recordId: recordId,
                status: normalizeStatus(n8nQuote.status),
                // projectStatus: n8nQuote.projectStatus || 'nytt', // <-- 2. DATA TRANSFORMATION: Avl√§gsnad. Denna tillh√∂r projektet.
                customer: n8nQuote.customerName || n8nQuote.kundeNavn || n8nQuote.customer || '',
                emne: n8nQuote.emne || '', // <-- NYTT: Legg til emne
                customerType: n8nQuote.customerType || n8nQuote.kundeType || 'Privat',
                customerIdNumber: n8nQuote.customerIdNumber || n8nQuote.orgnr || '',
                contactPerson: n8nQuote.contactPerson || n8nQuote.kontaktperson || '',
                contactEmail: n8nQuote.contactEmail || n8nQuote.epost || '',
                contactPhone: n8nQuote.contactPhone || n8nQuote.telefon || '',
                address: n8nQuote.address || n8nQuote.adresse || n8nQuote.monteringssted || '',
                // --- BORTTAGNA F√ÑLT ---
                // productCount: Number(n8nQuote.productCount || n8nQuote.antallEnheter) || 1,
                // productUnitCost: Number(n8nQuote.productUnitCost || n8nQuote.prisPerEnhet) || 0,
                // productDescription: n8nQuote.productDescription || n8nQuote.produktbeskrivelse || '',
                // --- NYA F√ÑLT ---
                linkedProducts: safeJsonParse(n8nQuote.linkedProducts, []),
                sentDate: n8nQuote.sentDate || null,
                approvedDate: n8nQuote.approvedDate || null,
                // ---
                customerRequests: n8nQuote.customerRequests || n8nQuote.kundensOnskemal || '',
                numInstallers: Number(n8nQuote.numInstallers || n8nQuote.antallMontorer) || 0,
                installerCost: Number(n8nQuote.installerCost || n8nQuote.montorKostnad) || 0,
                installationDate: n8nQuote.installationDate || n8nQuote.monteringsDato || new Date().toISOString().split('T')[0],
                installationEndDate: n8nQuote.installationEndDate || n8nQuote.monteringsSluttDato || n8nQuote.installationDate || new Date().toISOString().split('T')[0], // <-- MODIFIED
                total: Number(n8nQuote.total) || 0,
                discountAmount: Number(n8nQuote.discountAmount) || 0,
                internalComment: n8nQuote.internalComment || n8nQuote.interntNotat || '',
                customCosts: safeJsonParse(n8nQuote.customCosts, []),
                assignedStaff: safeJsonParse(n8nQuote.assignedStaff, []),
                attachments: safeJsonParse(n8nQuote.attachments, [])
            };
            
            // Om linkedProducts √§r tom, migrera fr√•n gamla f√§lt (f√∂r bak√•tkompatibilitet)
            if ((!quoteObject.linkedProducts || quoteObject.linkedProducts.length === 0) && n8nQuote.productDescription) {
                quoteObject.linkedProducts = [{
                    id: Date.now(),
                    productId: null, // Vi vet inte IDt
                    name: n8nQuote.productDescription.split(',')[0] || "Importert produkt",
                    quantity: Number(n8nQuote.productCount || n8nQuote.antallEnheter) || 1,
                    pricePerUnit: Number(n8nQuote.productUnitCost || n8nQuote.prisPerEnhet) || 0,
                    notes: n8nQuote.productDescription || ''
                }];
            }

            if (!quoteObject.total) {
                quoteObject.total = calculateTotal(quoteObject);
            }
            return quoteObject; // FIKS: La til manglende 'return'
        }

        function transformPortalQuoteToN8nQuote(portalQuote) {
            const payload = {
                recordId: portalQuote.recordId,
                offertId: portalQuote.id,
                projectId: portalQuote.projectId, // <-- NYTT F√ÑLT
                status: portalQuote.status,
                // projectStatus: portalQuote.projectStatus, // <-- 2. DATA TRANSFORMATION: Avl√§gsnad.
                customerName: portalQuote.customer,
                emne: portalQuote.emne, // <-- NYTT: Legg til emne
                customerType: portalQuote.customerType,
                customerIdNumber: portalQuote.customerIdNumber,
                contactPerson: portalQuote.contactPerson,
                contactEmail: portalQuote.contactEmail,
                contactPhone: portalQuote.contactPhone,
                address: portalQuote.address,
                // --- BORTTAGNA F√ÑLT ---
                // productCount: Number(portalQuote.productCount) || 0,
                // productUnitCost: Number(portalQuote.productUnitCost) || 0,
                // productDescription: portalQuote.productDescription,
                // --- NYA F√ÑLT ---
                linkedProducts: portalQuote.linkedProducts || [],
                sentDate: portalQuote.sentDate,
                approvedDate: portalQuote.approvedDate,
                // ---
                customerRequests: portalQuote.customerRequests,
                numInstallers: Number(portalQuote.numInstallers) || 0,
                installerCost: Number(portalQuote.installerCost) || 0,
                installationDate: portalQuote.installationDate,
                installationEndDate: portalQuote.installationEndDate, // <-- MODIFIED
                total: Number(portalQuote.total) || 0,
                discountAmount: Number(portalQuote.discountAmount) || 0,
                internalComment: portalQuote.internalComment,
                customCosts: portalQuote.customCosts || [],
                assignedStaff: portalQuote.assignedStaff || [],
                attachments: portalQuote.attachments || []
            };
            return payload; // FIKS: La til manglende 'return'
        }
        const themes = { 
            light: { bg: 'bg-slate-50', cardBg: 'bg-white', text: 'text-slate-800', textSecondary: 'text-slate-500', accent: 'text-amber-500', border: 'border-slate-200', inputBg: 'bg-slate-100', buttonPrimaryBg: 'bg-amber-500', buttonPrimaryText: 'text-white', buttonPrimaryHover: 'hover:bg-amber-600', buttonSecondaryBg: 'bg-slate-200', buttonSecondaryHover: 'hover:bg-slate-300', modalOverlay: 'bg-slate-900/60 backdrop-blur-sm', navActive: 'bg-amber-500/10 text-amber-600 border-amber-500', navInactive: 'text-slate-600 border-transparent hover:bg-slate-200/50', filterActive: 'bg-amber-500 text-white', focus: 'focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 ring-offset-slate-50', logoBg: 'bg-slate-100' },
            dark: { bg: 'bg-slate-900', cardBg: 'bg-slate-800', text: 'text-slate-200', textSecondary: 'text-slate-400', accent: 'text-amber-400', border: 'border-slate-700', inputBg: 'bg-slate-700', buttonPrimaryBg: 'bg-amber-500', buttonPrimaryText: 'text-slate-900', buttonPrimaryHover: 'hover:bg-amber-400', buttonSecondaryBg: 'bg-slate-700', buttonSecondaryHover: 'hover:bg-slate-600', modalOverlay: 'bg-slate-900/80 backdrop-blur-sm', navActive: 'bg-amber-500/10 text-amber-400 border-amber-500', navInactive: 'text-slate-400 border-transparent hover:bg-slate-700/50', filterActive: 'bg-amber-500 text-slate-900', focus: 'focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 ring-offset-slate-900', logoBg: 'bg-slate-800' }
        };
        const icons = {
            quotes: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>`,
            projects: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /></svg>`,
            suppliers: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 0 1-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h1.125c.621 0 1.125-.504 1.125-1.125V14.25m-17.25 4.5h1.125c.621 0 1.125-.504 1.125-1.125V14.25m0 0h1.5m1.5 0h1.5m1.5 0h1.5m1.5 0h1.5M4.5 14.25v-2.625c0-.621.504-1.125 1.125-1.125h11.25c.621 0 1.125.504 1.125 1.125V14.25m-13.5 0v-2.625c0-.621.504-1.125 1.125-1.125h11.25c.621 0 1.125.504 1.125 1.125V14.25" /></svg>`,
            products: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25A2.25 2.25 0 0 1 13.5 8.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z" /></svg>`,
            time: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>`,
            socials: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>`,
            analytics: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25A1.125 1.125 0 0 1 9.75 19.875V8.625ZM16.5 3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v16.5c0 .621-.504 1.125-1.125 1.125h-2.25A1.125 1.125 0 0 1 16.5 19.875V3.375Z" /></svg>`,
            calendar: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-9-6h.008v.008H12v-.008ZM12 15h.008v.008H12V15Zm0 2.25h.008v.008H12v-.008ZM9.75 15h.008v.008H9.75V15Zm0 2.25h.008v.008H9.75v-.008ZM7.5 15h.008v.008H7.5V15Zm0 2.25h.008v.008H7.5v-.008Zm6.75-4.5h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V15Zm0 2.25h.008v.008h-.008v-.008Zm2.25-4.5h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V15Zm0 2.25h.008v.008h-.008v-.008Z" /></svg>`,
            wishlist: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.404a.562.562 0 0 1 .31.986l-4.435 3.23a.563.563 0 0 0-.18.635l1.718 5.223a.563.563 0 0 1-.814.622l-4.47-3.255a.563.563 0 0 0-.652 0l-4.47 3.255a.563.563 0 0 1-.814-.622l1.718-5.223a.563.563 0 0 0-.18-.635l-4.435-3.23a.563.563 0 0 1 .31-.986h5.404a.563.563 0 0 0 .475-.31L11.48 3.5Z" /></svg>`,
            staff: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" /></svg>`,
            logout: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" /></svg>`,
            menu: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>`,
            sun: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-6.364-.386 1.591-1.591M3 12H.75m.386-6.364 1.591 1.591M12 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>`,
            moon: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" /></svg>`,
            grid: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25A2.25 2.25 0 0 1 13.5 8.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z" /></svg>`,
            list: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" /></svg>`,
            search: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg>`,
            x: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>`,
            plus: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>`,
            chevronDown: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>`,
            chevronUp: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 15.75 7.5-7.5 7.5 7.5" /></svg>`,
            chevronLeft: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg>`,
            chevronRight: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" /></svg>`,
            dotsVertical: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" /></svg>`,
            check: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>`,
            mail: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" /></svg>`,
            externalLink: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg>`,
            trash: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.54 0c-.34-.059-.68-.114-1.022-.165m10.042 0a48.29 48.29 0 0 0-10.042 0M9.75 4.5s-4.25 0-4.25 4.5s4.25 4.5 4.25 4.5m0-9s4.25 0 4.25 4.5s-4.25 4.5-4.25 4.5M1.5 6h21" /></svg>`,
            pencil: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>`,
            upload: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" /></svg>`,
            filePdf: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>`,
            cog: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0M3.75 18H7.5m3-6h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0M3.75 12H7.5m-3.75 0h.008v.008H3.75v-.008Zm0 0h.008v.008H3.75v-.008Zm0 0h.008v.008H3.75v-.008Zm0 0h.008v.008H3.75v-.008Zm0 0h.008v.008H3.75v-.008Zm0 0h.008v.008H3.75v-.008Zm0 0h.008v.008H3.75v-.008Zm0 0h.008v.008H3.75v-.008Z" /></svg>`,
            duplicate: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375v-3.375m0 0c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375-3.375-3.375" /></svg>`,
            arrowUp: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19.5v-15m0 0-6.75 6.75M12 4.5l6.75 6.75" /></svg>`,
            warning: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg>`,
            photo: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm1.5-6a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /></svg>`,
            heart: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" /></svg>`,
            heartFilled: (c) => `<svg class="${c}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.645 20.91a.75.75 0 0 1-1.29 0C8.324 18.68 2.25 13.562 2.25 8.25 2.25 5.32 4.616 3 7.5 3c1.753 0 3.323.904 4.5 2.274A5.02 5.02 0 0 1 16.5 3c2.884 0 5.25 2.32 5.25 5.25 0 5.312-6.075 10.43-8.105 12.66Z" /></svg>`,
        };

        const dataService = new DataService();

        const formatDate = (date) => new Date(date).toLocaleDateString('no-NO', { year: 'numeric', month: '2-digit', day: '2-digit' });
        const calculatePriceDetails = (q) => {
            // --- UPPDATERAD BER√ÑKNING ---
            const productSubtotal = (q.linkedProducts || []).reduce((sum, item) => {
                return sum + ((Number(item.quantity) || 0) * (Number(item.pricePerUnit) || 0));
            }, 0);
            // --- SLUT UPPDATERING ---

            const staffSubtotal = (Number(q.installerCost) || 0);
            
            const customCosts = (q.customCosts || []).reduce((sum, c) => sum + (Number(c.amount) || 0), 0);
            const subtotal = productSubtotal + staffSubtotal + customCosts;
            const discountAmount = Number(q.discountAmount) || 0;
            const total = subtotal - discountAmount;
            return { productSubtotal, staffSubtotal, customCosts, subtotal, discountAmount, total };
        }
        async function handleSendProposal(quote) {
            const updatedQuote = { ...quote, status: 'f√∂rslag-skickat', sentDate: new Date().toISOString() }; // NYTT: S√§tt sentDate
            const optimisticQuotes = state.quotes.map(q => q.id === updatedQuote.id ? updatedQuote : q);
            // Ist√§llet f√∂r att anropa n8n, simulera mejlet direkt.
            setState({ simulatedEmailQuote: updatedQuote, quotes: optimisticQuotes, selectedQuoteId: null });
        }
        async function handleCustomerResponse(quote, responseStatus) {
            const updatedQuote = { ...quote, status: responseStatus };
            let updatedProjects = state.projects; // <-- 3. CRUD REFACTORING: H√§mta projekt
            
            if(responseStatus === 'godk√§nd') {
                // updatedQuote.projectStatus = 'planlagt'; // <-- 3. CRUD REFACTORING: Avl√§gsnad
                updatedQuote.approvedDate = new Date().toISOString(); // NYTT: S√§tt approvedDate
                
                // --- NY PROJEKTUPPDATERING ---
                // Hitta det associerade projektet och uppdatera dess status
                updatedProjects = state.projects.map(p => {
                    if (p.projectId === updatedQuote.projectId) {
                        // Uppdatera bara om statusen √§r 'nytt'. Ers√§tt inte 'p√•g√•r' etc.
                        if (p.projectStatus === 'nytt') { 
                            return { ...p, projectStatus: 'planlagt' };
                        }
                    }
                    return p;
                });
                // --- SLUTT NY LOGIK ---
            }

            const updatedQuotes = state.quotes.map(q => q.id === updatedQuote.id ? updatedQuote : q);
            setState({ quotes: updatedQuotes, projects: updatedProjects, simulatedEmailQuote: null }); // <-- 3. CRUD REFACTORING: Spara projects

            try {
                await dataService.saveQuote(transformPortalQuoteToN8nQuote(updatedQuote));
                // TODO: Implementera dataService.saveProject(project) h√§r
            } catch (error) {
                console.error("Feil ved lagring av kundrespons:", error);
                // Her kan man vurdere √• rulle tilbake endringen
            }
        }
        async function handleDeleteQuote(quote) {
            try {
                await dataService.deleteQuote(quote.recordId);
                const updatedQuotes = state.quotes.filter(q => q.id !== quote.id);
                
                // --- 3. CRUD REFACTORING: Projekt-synkronisering ---
                // Kontrollera om detta var det sista tilbudet f√∂r projektet
                const remainingQuotesForProject = updatedQuotes.some(q => q.projectId === quote.projectId);
                let updatedProjects = state.projects;
                if (!remainingQuotesForProject) {
                    // Om inga tilbud kvar, ta bort projektet
                    updatedProjects = state.projects.filter(p => p.projectId !== quote.projectId);
                } else {
                    // Annars, ta bara bort quoteId fr√•n projektets lista
                    updatedProjects = state.projects.map(p => {
                        if (p.projectId === quote.projectId) {
                            return { ...p, quoteIds: p.quoteIds.filter(id => id !== quote.id) };
                        }
                        return p;
                    });
                }
                // --- SLUTT NY LOGIK ---
                
                setState({ quotes: updatedQuotes, projects: updatedProjects, isDeleteConfirmModalOpen: false, quoteToDelete: null }); // <-- 3. CRUD REFACTORING: Spara projects
                showToast(t('toast.deleted'), 'success');
            } catch (error) {
                console.error("Feil ved sletting:", error);
                showToast(t('toast.delete_failed'), 'error');
                setState({ isDeleteConfirmModalOpen: false, quoteToDelete: null });
            }
        }

        // --- NY FUNKSJON FOR KORT-REDIGERING ---
        async function handleCardEmneChange(quote, newEmne) {
            // Sjekk om det faktisk er en endring
            if (quote.emne === newEmne) return;

            const updatedQuote = { ...quote, emne: newEmne };
            
            // 1. Optimistisk UI-oppdatering (kun i state, ingen re-render)
            const updatedQuotes = state.quotes.map(oldQuote => 
                oldQuote.id === updatedQuote.id ? updatedQuote : oldQuote
            );
            // Vi kaller setState uten render for √• oppdatere bakgrunns-state
            // Dette forhindrer at fokus mistes fra contentEditable-feltet.
            setState({ quotes: updatedQuotes }, { render: false }); 

            // 2. Lagre endringen til databasen
            try {
                await dataService.saveQuote(transformPortalQuoteToN8nQuote(updatedQuote));
                showToast('Emne lagret.', 'success');
            } catch (error) {
                console.error("Feil ved lagring av emne fra kort:", error);
                showToast('Kunne ikke lagre emne.', 'error');
                // Valgfritt: Rull tilbake endringen i state hvis lagring feiler
                // (Men for √• holde det enkelt, lar vi den optimistiske endringen best√•)
            }
        }
        // --- SLUTT P√Ö NY FUNKSJON ---

        function handleNewQuote() { 
            const newId = `PS-${Date.now()}`; 
            // Generera ett nytt unikt projekt-ID f√∂r detta nya tillbud
            const newProjectId = `PJ-${Date.now()}`;
            const q = { 
                id: newId, 
                projectId: newProjectId, // <-- NYTT F√ÑLT
                recordId: null, 
                status: 'utkast', 
                // projectStatus: 'nytt', // <-- 3. CRUD REFACTORING: Avl√§gsnad
                installationDate: new Date().toISOString().split('T')[0], 
                installationEndDate: new Date().toISOString().split('T')[0], // <-- MODIFIED
                customCosts:[], 
                assignedStaff:[], 
                linkedProducts: [] 
            }; 
            q.total = calculateTotal(q); 
            
            // --- 3. CRUD REFACTORING: Skapa Projekt-objekt ---
            const newProject = {
                projectId: newProjectId,
                projectStatus: 'nytt', // Standard projekt-status
                customerName: '', // Kommer att fyllas i vid spara
                address: '', // Kommer att fyllas i vid spara
                quoteIds: [newId] // L√§gg till detta f√∂rsta tilbud
            };
            const updatedProjects = [...state.projects, newProject];
            // --- SLUTT NY LOGIK ---
            
            setState({ selectedQuoteId: newId, formData: q, projects: updatedProjects }); // <-- 3. CRUD REFACTORING: Spara projects
        }
        
        // NY FUNKSJON FOR PRODUKTER
        async function handleSaveProduct(productData) {
            const isEditing = !!productData.id;
            const product = { ...productData };
            if (!isEditing) {
                product.id = `prod-${Date.now()}`;
                state.products.push(product);
            } else {
                state.products = state.products.map(p => p.id === product.id ? product : p);
            }
            setState({ products: state.products, productToEdit: null });
            showToast(t('toast.product_saved'), 'success');
        }
        
        // NY FUNKSJON FOR PRODUKTER
        async function handleDeleteProduct(product) {
            state.products = state.products.filter(p => p.id !== product.id);
            setState({ products: state.products, isDeleteProductConfirmOpen: false, productToDelete: null });
            showToast(t('toast.product_deleted'), 'success');
        }

        // --- NYA FUNKSJONER F√ñR ANSATTE ---
        async function handleSaveStaff(staffData) {
            const isEditing = !!staffData.id;
            const staff = { ...staffData };
            if (!isEditing) {
                staff.id = `staff-${Date.now()}`;
                state.staff.push(staff);
            } else {
                state.staff = state.staff.map(s => s.id === staff.id ? staff : s);
            }
            setState({ staff: state.staff, staffToEdit: null });
            showToast('Ansatt lagret!', 'success'); // B√∏r legges til i texts-objektet senere
        }

        async function handleDeleteStaff(staff) {
            state.staff = state.staff.filter(s => s.id !== staff.id);
            setState({ staff: state.staff, isDeleteStaffConfirmOpen: false, staffToDelete: null });
            showToast('Ansatt slettet!', 'success'); // B√∏r legges til i texts-objektet senere
        }
        // --- SLUTT NYA FUNKSJONER ---
        
        // --- NY FUNKSJON: Henter relaterade offerter ---
        function getSiblingQuotes(currentQuote) {
            if (!currentQuote.projectId) return [];
            return state.quotes.filter(q => q.projectId === currentQuote.projectId && q.id !== currentQuote.id);
        }

        // PDF Export with Graceful Degradation
        const exportToPDF = (quote) => {
            if (window.PDF_UNAVAILABLE || !window.jsPDF) {
                showToast('PDF-eksport er ikke tilgjengelig. Pr√∏v √• laste siden p√• nytt.', 'warning');
                return;
            }
        
            try {
                const { jsPDF } = window;
                const doc = new jsPDF({ unit: 'pt' });
                const theme = themes[state.theme];
                const accentColor = theme.accent.includes('amber-500') ? '#f59e0b' : '#f59e0b';
                
                // FIKS: La til https:
                doc.addFont('https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7.woff2', 'Inter', 'normal');
                doc.addFont('https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7.woff2', 'Inter', 'bold');
                doc.setFont('Inter', 'normal');
                
                // Logo & Header
                doc.setFillColor(theme.logoBg.includes('slate-100') ? '#f1f5f9' : '#1e293b');
                doc.rect(0, 0, doc.internal.pageSize.width, 100, 'F');
                doc.setFontSize(26).setFont('Inter', 'bold').setTextColor(accentColor).text('PRIMA SOL', 40, 60);
                
                doc.setFontSize(16).setFont('Inter', 'bold').setTextColor(theme.text.includes('slate-800') ? '#1e293b' : '#f1f5f9').text('TILBUD', 460, 60);
                
                // Mottaker
                let customerY = 140;
                doc.setFontSize(10).setFont('Inter', 'bold').setTextColor(accentColor).text('MOTTAKER', 40, customerY);
                customerY += 15;
                doc.setFontSize(11).setFont('Inter', 'normal').setTextColor(theme.text.includes('slate-800') ? '#334155' : '#e2e8f0');
                doc.text(quote.customer, 40, customerY);
                if (quote.contactPerson) doc.text(quote.contactPerson, 40, customerY += 15);
                if (quote.address) doc.text(quote.address, 40, customerY += 15);
                if (quote.contactEmail) doc.text(quote.contactEmail, 40, customerY += 15);
                
                // Info (Tilbudsnr, Dato, Emne etc.) // <-- ENDRING: La til Emne her
                let infoY = 140;
                doc.setFontSize(10).setFont('Inter', 'bold').setTextColor(accentColor).text('TILBUDSNR', 400, infoY);
                doc.setFontSize(11).setFont('Inter', 'normal').setTextColor(theme.text.includes('slate-800') ? '#334155' : '#e2e8f0').text(quote.id, 500, infoY);
                infoY += 20;
                doc.setFontSize(10).setFont('Inter', 'bold').setTextColor(accentColor).text('DATO', 400, infoY);
                doc.setFontSize(11).setFont('Inter', 'normal').text(new Date().toLocaleDateString('no-NO'), 500, infoY);
                infoY += 20;
                doc.setFontSize(10).setFont('Inter', 'bold').setTextColor(accentColor).text('EMNE', 400, infoY); // <-- NYTT: Emne i PDF
                doc.setFontSize(11).setFont('Inter', 'normal').text(quote.emne || 'Standardtilbud', 500, infoY); // <-- NYTT: Emne i PDF
                infoY += 20;
                doc.setFontSize(10).setFont('Inter', 'bold').setTextColor(accentColor).text('MONTERINGSDATO', 400, infoY);
                doc.setFontSize(11).setFont('Inter', 'normal').text(formatDate(quote.installationDate), 500, infoY);
                
                let menuYStart = customerY > infoY ? customerY + 40 : infoY + 40; // <-- ENDRING: Juster startY basert p√• h√∏yeste kolonne
                doc.setFontSize(11).setFont('helvetica', 'bold').text('PRODUKTBESKRIVELSE', 14, menuYStart);
                 
                 // --- UPPDATERAD F√ñR ATT VISA L√ÑNKADE PRODUKTER ---
                 const productLines = (quote.linkedProducts || []).map(item => {
                    return `${item.quantity} stk. ${item.name} (${(item.pricePerUnit || 0).toLocaleString('no-NO')} kr/stk) \n     Notat: ${item.notes || 'Ingen'}`;
                 });
                 const productText = productLines.join('\n\n') || 'Ingen produkter spesifisert.';
                 // ---
    
                 const menuLines = doc.splitTextToSize(productText, 182);
                 doc.setFont('helvetica', 'normal').text(menuLines, 14, menuYStart + 6);
                 
                 const details = calculatePriceDetails(quote);
                 const formatCurrency = (amount) => (amount || 0).toLocaleString('no-NO') + ' kr';
                 
                 const tableRows = [];
                 // --- UPPDATERAD F√ñR L√ÑNKADE PRODUKTER ---
                 (quote.linkedProducts || []).forEach(item => {
                    tableRows.push([
                        item.name,
                        `${(item.pricePerUnit || 0).toLocaleString('no-NO')} kr x ${item.quantity}`,
                        formatCurrency((item.quantity || 0) * (item.pricePerUnit || 0))
                    ]);
                 });
                 // ---
                 // tableRows.push(['Produkter', `${(quote.productUnitCost || 0).toLocaleString('no-NO')} kr x ${quote.productCount}`, formatCurrency((quote.productCount || 0) * (quote.productUnitCost || 0))]); // Gammal rad
                 if (quote.installerCost > 0) tableRows.push(['Montering', 'Fast kostnad', formatCurrency(quote.installerCost)]); 
                 (quote.customCosts || []).forEach(c => tableRows.push([c.description, `Ekstra kostnad (${c.vatRate || 25}%)`, formatCurrency(c.amount)])); 
                 
                 tableRows.push(['', 'Subtotal', formatCurrency(details.subtotal)]);
                 if (details.discountAmount > 0) tableRows.push(['', 'Rabatt', `-${formatCurrency(details.discountAmount)}`]);
                 tableRows.push(['', 'Total (eks. mva)', formatCurrency(details.total)]);
                 
                 doc.autoTable({
                    startY: menuYStart,
                    head: [['Beskrivelse', 'Detaljer', 'Sum']],
                    body: tableRows,
                    theme: 'grid',
                    margin: { left: 210 },
                    styles: {
                        font: 'Inter',
                        fillColor: theme.cardBg.includes('white') ? '#ffffff' : '#1e293b',
                        textColor: theme.text.includes('slate-800') ? '#334155' : '#e2e8f0',
                        lineColor: theme.border.includes('slate-200') ? '#e2e8f0' : '#475569',
                        lineWidth: 0.5
                    },
                    headStyles: {
                        fillColor: theme.bg.includes('slate-50') ? '#f8fafc' : '#0f172a',
                        textColor: theme.text.includes('slate-800') ? '#1e293b' : '#f1f5f9',
                        fontStyle: 'bold'
                    },
                    didDrawCell: (data) => {
                        if (data.section === 'body' && data.row.index >= tableRows.length - 3) {
                            data.cell.styles.fontStyle = 'bold';
                        }
                    }
                 });
                
                doc.save(`Tilbud-${quote.id}.pdf`);
            } catch (error) {
                console.error('PDF Export Error:', error);
                showToast('Kunne ikke generere PDF. Pr√∏v igjen.', 'error');
            }
        };

        function renderEmailSimulation(q) {
            const theme = themes[state.theme];
            return createElement('div', { className: `fixed inset-0 z-40 ${theme.modalOverlay} animate-fade-in-fast flex items-center justify-center p-4`},
                createElement('div', { className: `w-full max-w-xl ${theme.cardBg} rounded-xl shadow-2xl animate-fade-in-scale`},
                    createElement('h3', { className: `p-4 border-b ${theme.border} font-bold text-lg`}, `E-post simulasjon: Tilbud til ${q.customer}`),
                    createElement('div', { className: 'p-6 space-y-4'},
                        createElement('p', {}, `Hei ${q.contactPerson || q.customer},`),
                        createElement('p', {}, `Takk for din henvendelse! Vedlagt finner du v√•rt tilbud for prosjektet med montering den ${formatDate(q.installationDate)}.`),
                        createElement('button', {
                            className: `inline-flex items-center gap-2 px-4 py-2 border ${theme.border} rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover}`,
                            innerHTML: icons.filePdf('w-5 h-5') + `Tilbud-${q.id}.pdf`
                        }),
                        createElement('p', { className: `text-sm ${theme.textSecondary} italic`}, `(Dette er en simulering. E-posten er ikke sendt.)`)
                    ),
                    createElement('footer', { className: `p-4 border-t ${theme.border} flex justify-between gap-4`},
                        createElement('div', { className: 'flex flex-col' },
                            createElement('span', { className: 'text-sm font-semibold' }, 'Godta tilbudet?'),
                            createElement('span', { className: `text-xs ${theme.textSecondary}`}, '(Simulerer kundens svar)')
                        ),
                        createElement('div', { className: 'flex gap-2'},
                            createElement('button', {
                                className: `px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700`,
                                onclick: () => handleCustomerResponse(q, 'f√∂rlorad')
                            }, 'Avsl√•'),
                            createElement('button', {
                                className: `px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700`,
                                onclick: () => handleCustomerResponse(q, 'godk√§nd')
                            }, 'Godta')
                        )
                    )
                )
            );
        }
        
        // --- NY FUNKSJON F√ñR PROJEKTSAMMANFATTNING ---
        function renderProjectSummary(q, theme, createSection) { // <-- FIX: Accept createSection as an argument
            const siblings = getSiblingQuotes(q);
            if (siblings.length === 0) return createSection('Relaterade Tillbud', 'projectSummary', [
                 createElement('div', { className: 'sm:col-span-2 p-2 rounded-lg bg-blue-50 dark:bg-blue-900/50 text-sm text-blue-700 dark:text-blue-300' }, 
                `Dette tilbudet er unikt i Prosjekt ID: ${q.projectId}.`
            )]);

            const list = createElement('div', { className: 'space-y-2' });
            siblings.forEach(s => {
                const pillStyle = getStatusPillStyles(s.status, theme);
                list.append(createElement('div', { 
                    className: `flex items-center justify-between p-3 rounded-lg border ${theme.border} ${theme.cardBg} cursor-pointer hover:${theme.buttonSecondaryHover}`,
                    onclick: () => {
                        // Bytter till det relaterade tillbudet i modalen
                        setState({ 
                            selectedQuoteId: s.id, 
                            formData: { ...s },
                            openSections: { info: true, projectSummary: true } // √ñppnar info- & Project Summary-sektionerna
                        });
                    }
                },
                    createElement('span', { className: 'font-medium truncate' }, `${s.customer} (${s.address})`),
                    createElement('span', { className: `px-3 py-0.5 rounded-full text-xs font-semibold ${pillStyle}` }, t(`status.${s.status}`))
                ));
            });

            return createSection(`Relaterade Tillbud (${siblings.length}) - Prosjekt: ${q.projectId}`, 'projectSummary', [ 
                createElement('div', { className: 'sm:col-span-2 mt-4 space-y-3' }, list)
            ]);
        }
        // --- SLUTT NY FUNKSJON ---

        function renderModal(quoteId) {
            const q = state.formData;
            if (!q) return;
            const theme = themes[state.theme];
            const fragment = document.createDocumentFragment();
            
            const closeModal = () => {
                const modal = document.getElementById('project-modal');
                if (modal) {
                    modal.classList.add('animate-slide-out-down');
                    modal.querySelector('div > div').classList.remove('animate-slide-in-up');
                    modal.addEventListener('animationend', () => setState({ selectedQuoteId: null, formData: null, openSections: {} }), { once: true });
                } else {
                     setState({ selectedQuoteId: null, formData: null, openSections: {} });
                }
            };

            const modalPositioner = createElement('div', { 
                id: 'project-modal', 
                className: `fixed inset-0 z-30 ${theme.modalOverlay} flex items-end md:items-center justify-center`, 
                onclick: closeModal 
            });
            
            const update = (key, value) => { 
                state.formData[key] = value; // <-- FIX: Mutate the object, don't replace it
                const details = calculatePriceDetails(state.formData); // Reads the same mutated object
                state.formData.total = details.total; // Mutates the same mutated object
                const totalEl = document.getElementById('modal-total-price');
                if (totalEl) totalEl.textContent = `${details.total.toLocaleString('no-NO')} kr`;
                const mobileTotalEl = document.getElementById('mobile-total-price');
                if(mobileTotalEl) mobileTotalEl.textContent = `Totalt: ${details.total.toLocaleString('no-NO')} kr`;
            };
            
            const statusSelector = createElement('div', { className: 'relative' });
            const statusButton = createElement('button', { 
                className: `px-3 py-1 rounded-full text-sm font-semibold ${getStatusPillStyles(q.status, theme)}`,
                onclick: e => { 
                    e.stopPropagation(); 
                    // --- FIX: START ---
                    // Manually close any existing menus first
                    document.querySelectorAll('#global-card-status-menu, #global-filter-status-menu, .project-status-menu, #modal-product-search-menu').forEach(m => m.remove());
                    
                    const rect = e.currentTarget.getBoundingClientRect(); 
                    
                    // Manually update state (for the changer function to read) but DO NOT RENDER
                    setState({ isModalStatusOpen: true, modalStatusMenuTarget: rect }, { render: false });
                    
                    // Manually create and append the menu
                    // renderGlobalStatusChanger will use the state we just set
                    const menu = renderGlobalStatusChanger(rect, q); // <-- FIX: Pass the local 'q' object (which is state.formData)
                    if (menu) {
                        appRoot.append(menu);
                    }
                    // --- FIX: END ---
                } 
            }, t(`status.${q.status}`), createElement('span', {className:'ml-1'}, '‚ñæ'));
            statusSelector.append(statusButton);
            
            // --- NY HJ√ÑLPFUNKTION: Skapar den s√∂kbara menyn f√∂r projekt ---
            const renderProjectLinkerSearchMenu = (theme, q, update, createSection) => {
                // 1. H√§mta unika projekt
                const allProjectIds = state.quotes.map(q => q.projectId).filter(Boolean);
                const uniqueProjectIds = [...new Set(allProjectIds)];
                let projects = uniqueProjectIds.map(id => {
                    const firstQuote = state.quotes.find(q => q.projectId === id);
                    return { id: id, customer: firstQuote?.customer || 'Ok√§nd kund' }; // Fallback
                }).sort((a, b) => a.customer.localeCompare(b.customer)); // Sortera alfabetiskt

                // 2. Skapa meny-elementet
                const menu = createElement('div', { 
                    id: 'modal-project-linker-menu', 
                    className: `absolute w-full md:w-96 ${theme.cardBg} rounded-lg shadow-2xl border ${theme.border} z-50 animate-fade-in-fast flex flex-col`,
                    style: 'max-height: 300px;' // Begr√§nsa h√∂jden
                });
                
                const listContainer = createElement('div', { className: 'overflow-y-auto' });

                // 3. S√∂kfunktion
                const searchInput = createElement('input', {
                    type: 'text',
                    placeholder: 'S√∂k efter projekt-ID eller kund...',
                    className: `w-full p-3 border-b ${theme.border} ${theme.inputBg} sticky top-0`,
                    oninput: (e) => {
                        const term = e.target.value.toLowerCase();
                        listContainer.innerHTML = ''; // Rensa listan
                        const filtered = projects.filter(p => p.id.toLowerCase().includes(term) || p.customer.toLowerCase().includes(term));
                        filtered.forEach(p => listContainer.append(createItem(p)));
                    }
                });

                // 4. Funktion f√∂r att skapa ett listobjekt
                const createItem = (project) => {
                    return createElement('a', {
                        href: '#',
                        className: `block px-4 py-3 text-sm ${theme.text} hover:bg-slate-100 dark:hover:bg-slate-700`,
                        onclick: (ev) => {
                            ev.preventDefault();
                            
                            // A. Uppdatera state
                            update('projectId', project.id);
                            
                            // B. DOM Hotswap: Uppdatera "Relaterade Tillbud"-sektionen
                            const newSummarySection = renderProjectSummary(q, theme, createSection); // q √§r state.formData
                            const oldSummarySection = document.getElementById('project-summary-section');
                            if (oldSummarySection) {
                                oldSummarySection.replaceWith(newSummarySection);
                            }
                            
                            // C. Uppdatera sj√§lva input-f√§ltet
                            const projectIdInput = document.getElementById('project-id-input');
                            if (projectIdInput) projectIdInput.value = project.id;
                            
                            menu.remove();
                        }
                    }, 
                    createElement('p', { className: 'font-semibold' }, project.customer),
                    createElement('p', { className: `text-xs ${theme.textSecondary}` }, project.id)
                    );
                };
                
                projects.forEach(p => listContainer.append(createItem(p)));
                menu.append(searchInput, listContainer);
                return menu;
            };
            // --- SLUT P√Ö NY HJ√ÑLPFUNKTION ---


            // --- START MODIFISERING: Redigerbart Emne i Header ---
            const editableTitle = createElement('h2', {
                className: 'text-xl font-bold p-1 -m-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700 cursor-text transition-all-smooth',
                title: 'Klikk for √• redigere emne',
                // Viser "Opprett..." for nye tilbud, ellers viser den emnet.
                innerHTML: q.emne || (q.recordId ? 'Standardtilbud' : t('modal.create_title')), 
                onclick: (e) => {
                    const el = e.currentTarget;
                    if (el.contentEditable === 'true') return;
                    el.contentEditable = 'true';
                    el.focus();
                    el.dataset.originalValue = el.textContent;
                    document.execCommand('selectAll', false, null);
                },
                onblur: (e) => {
                    const el = e.currentTarget;
                    el.contentEditable = 'false';
                    el.classList.remove('outline', 'outline-2', 'outline-amber-500');
                    const newEmne = el.textContent.trim();
                    
                    if (newEmne === "") {
                        el.textContent = el.dataset.originalValue;
                        update('emne', el.dataset.originalValue); // Oppdaterer state.formData
                    } else {
                        el.textContent = newEmne;
                        update('emne', newEmne); // Oppdaterer state.formData
                    }
                },
                onfocus: (e) => {
                    e.currentTarget.classList.add('outline', 'outline-2', 'outline-amber-500');
                },
                onkeydown: (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        e.currentTarget.blur();
                    } else if (e.key === 'Escape') {
                        e.currentTarget.textContent = e.currentTarget.dataset.originalValue;
                        e.currentTarget.blur();
                    }
                }
            });

            const headerContent = createElement('div', {className: 'flex-grow flex items-center gap-4'}, 
                editableTitle, // Erstattet den gamla <h2>
                statusSelector
            );
            // --- SLUTT MODIFISERING ---
            
            const header = createElement('header', { className: `flex-shrink-0 p-4 border-b ${theme.border}` }, createElement('div', {className: 'flex items-center justify-between'}, headerContent, createElement('div', {className:'flex items-center gap-2'}, createElement('button', {className:`p-2 ${theme.buttonSecondaryBg} rounded-lg transition-all-smooth btn-interaction`, innerHTML:icons.upload('w-5 h-5'), onclick:()=>showToast(t('toast.fortnox_sent'), 'info')}), createElement('button', {className:`p-2 ${theme.buttonSecondaryBg} rounded-lg transition-all-smooth btn-interaction`, innerHTML:icons.filePdf('w-5 h-5'), onclick:()=>exportToPDF(q)}), createElement('button', {className:`p-2 ${theme.buttonSecondaryBg} rounded-lg transition-all-smooth btn-interaction`, innerHTML:icons.x('w-5 h-5'), onclick:closeModal}))));
            
            const createField = (key, label, type='text', fullWidth=false, readOnly=false) => {
                let displayValue = q[key] || (type === 'number' ? 0 : '');
                if (readOnly && (key === 'sentDate' || key === 'approvedDate') && q[key]) {
                    displayValue = new Date(q[key]).toLocaleString('no-NO', { dateStyle: 'medium', timeStyle: 'short' });
                }

                const props = {
                    type, value: displayValue,
                    className: `w-full p-3 rounded-lg border ${theme.border} ${theme.inputBg}`,
                    oninput: e => { if (type !== 'number' && type !== 'date') update(key, e.target.value); },
                    onchange: e => { if (type === 'number' || type === 'date') update(key, type === 'number' ? Number(e.target.value) : e.target.value); }
                };
                if(type==='time') {
                    props.value = q[key] || '00:00';
                    props.readOnly = true;
                    props.onclick = () => setState({isTimePickerOpen: true, timePickerTarget: key});
                }
                if(readOnly) {
                    props.readOnly = true;
                    props.className += ` ${theme.inputBg.replace('bg-slate-100', 'bg-slate-50')} dark:bg-slate-800 cursor-not-allowed opacity-70`;
                }
                const input = createElement('input', props);
                return createElement('div', {className: fullWidth ? 'sm:col-span-2' : ''}, createElement('label', {className:'block text-sm font-medium mb-1'}, label), input);
            };

            // --- NYTT: Anpassad komponent f√∂r Projekt-ID ---
            const createProjectLinkerField = (key, label) => {
                const container = createElement('div', { className: 'relative' });
                
                const labelEl = createElement('label', { className: 'block text-sm font-medium mb-1' }, label);
                
                const inputGroup = createElement('div', { className: 'flex' });
                const input = createElement('input', {
                    type: 'text',
                    id: 'project-id-input', // Ge ett ID f√∂r uppdatering
                    value: q[key] || '',
                    className: `w-full p-3 rounded-l-lg border ${theme.border} ${theme.inputBg}`,
                    oninput: e => update(key, e.target.value),
                    onchange: e => {
                        // Manuell DOM Hotswap vid manuell √§ndring
                        const newSummarySection = renderProjectSummary(q, theme, createSection);
                        const oldSummarySection = document.getElementById('project-summary-section');
                        if (oldSummarySection) oldSummarySection.replaceWith(newSummarySection);
                    }
                });

                const linkButton = createElement('button', {
                    type: 'button',
                    className: `px-3 py-3 border-t border-b border-r ${theme.border} ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover} rounded-r-lg`,
                    innerHTML: icons.search('w-5 h-5'),
                    onclick: (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('#modal-project-linker-menu, #modal-product-search-menu').forEach(m => m.remove());
                        
                        const menu = renderProjectLinkerSearchMenu(theme, q, update, createSection);
                        
                        // Positionera menyn
                        const rect = input.getBoundingClientRect();
                        menu.style.top = `${rect.bottom + 5}px`;
                        menu.style.left = `${rect.left}px`;
                        menu.style.width = `${rect.width}px`; // Matcha bredden
                        
                        document.body.append(menu);
                    }
                });

                inputGroup.append(input, linkButton);
                container.append(labelEl, inputGroup);
                return container;
            };
            // --- SLUT P√Ö NY KOMPONENT ---

            const createTextarea = (key, label) => createElement('div', {className:'sm:col-span-2'}, createElement('label', {className:'block text-sm font-medium mb-1'}, label), createElement('textarea', {oninput: e=>update(key,e.target.value), className:`w-full p-3 rounded-lg border ${theme.border} ${theme.inputBg} min-h-[100px]`}, q[key]||''));
            
            // --- HELT NY FUNKSJON SOM BYGGER UI F√ñR L√ÑNKADE PRODUKTER ---
            const createLinkedProductsFields = () => {
                const container = createElement('div', { className: 'sm:col-span-2 space-y-4' });
                const listEl = createElement('div', { id: 'modal-linked-products-list', className: 'space-y-3' });
                
                // Knappen f√∂r att visa produktv√§ljaren
                const addProductButton = createElement('button', { 
                    type: 'button', 
                    className: `text-sm font-semibold ${theme.accent} flex items-center gap-1`,
                    onclick: (e) => {
                        e.stopPropagation();
                        const existingMenu = document.getElementById('modal-product-search-menu');
                        if (existingMenu) {
                            existingMenu.remove();
                            return;
                        }
                        
                        const targetRect = e.currentTarget.getBoundingClientRect();
                        const menu = createElement('div', { 
                            id: 'modal-product-search-menu', 
                            className: `absolute w-full md:w-96 max-h-64 overflow-y-auto ${theme.cardBg} rounded-lg shadow-2xl border ${theme.border} z-20 animate-fade-in-fast`,
                            style: { top: `${targetRect.bottom + 5}px`, left: `${targetRect.left}px` }
                        });

                        state.products.forEach(prod => {
                            menu.append(createElement('a', { 
                                href: '#', 
                                className: `block px-4 py-3 text-sm ${theme.text} hover:bg-slate-100 dark:hover:bg-slate-700`, 
                                onclick: (ev) => {
                                    ev.preventDefault();
                                    const newItem = {
                                        id: Date.now(),
                                        productId: prod.id,
                                        name: prod.name,
                                        quantity: 1,
                                        pricePerUnit: 0, // Tvingar anv√§ndaren att s√§tta pris
                                        notes: ''
                                    };
                                    const newItems = [...(state.formData.linkedProducts || []), newItem];
                                    update('linkedProducts', newItems);
                                    renderLinkedProductsList(theme, state.formData, update); // Uppdatera listan
                                    menu.remove();
                                } 
                            }, 
                            createElement('p', { className: 'font-semibold' }, prod.name),
                            createElement('p', { className: `text-xs ${theme.textSecondary}` }, `${prod.category} ‚Ä¢ ${state.suppliers.find(s => s.id === prod.supplierId)?.name || 'Ukjent'}`)
                            ));
                        });
                        document.body.append(menu); // L√§gg till i body f√∂r korrekt positionering
                    }
                }, createElement('div', { innerHTML: icons.plus('w-4 h-4') }), 'Legg til produkt');

                container.append(listEl, addProductButton);
                return container;
            };

            // --- HELT NY FUNKSJON SOM RENDERAR LISTAN MED PRODUKTER ---
            const renderLinkedProductsList = (theme, q, update) => {
                const listEl = document.getElementById('modal-linked-products-list');
                if (!listEl) return;
                listEl.innerHTML = ''; // Rensa
                
                (q.linkedProducts || []).forEach(item => {
                    const itemRow = createElement('div', { className: `p-3 rounded-lg border ${theme.border} ${theme.inputBg} space-y-2` });
                    
                    const header = createElement('div', { className: 'flex justify-between items-center' });
                    header.append(
                        createElement('span', { className: 'font-semibold' }, item.name),
                        createElement('button', { 
                            className: 'p-1', 
                            innerHTML: icons.trash('w-4 h-4 text-red-500'),
                            onclick: () => {
                                const newItems = state.formData.linkedProducts.filter(p => p.id !== item.id);
                                update('linkedProducts', newItems);
                                renderLinkedProductsList(theme, state.formData, update); // Uppdatera listan
                            }
                        })
                    );

                    const inputs = createElement('div', { className: 'grid grid-cols-2 gap-2' });
                    // Antall
                    inputs.append(createElement('div', {},
                        createElement('label', { className: 'text-xs font-medium' }, 'Antall'),
                        createElement('input', { 
                            type: 'number', 
                            value: item.quantity, 
                            className: `w-full p-2 rounded-md border ${theme.border} ${theme.cardBg}`,
                            onchange: e => {
                                const p = q.linkedProducts.find(p => p.id === item.id); // <-- FIX: Use 'q'
                                p.quantity = Number(e.target.value);
                                update('linkedProducts', q.linkedProducts); // <-- FIX: Use 'q'
                            }
                        })
                    ));
                    // Pris per enhet
                    inputs.append(createElement('div', {},
                        createElement('label', { className: 'text-xs font-medium' }, 'Pris/stk (eks. mva)'),
                        createElement('input', { 
                            type: 'number', 
                            value: item.pricePerUnit, 
                            className: `w-full p-2 rounded-md border ${theme.border} ${theme.cardBg}`,
                            onchange: e => {
                                const p = q.linkedProducts.find(p => p.id === item.id); // <-- FIX: Use 'q'
                                p.pricePerUnit = Number(e.target.value);
                                update('linkedProducts', q.linkedProducts); // <-- FIX: Use 'q'
                            }
                        })
                    ));

                    // Anteckningar
                    const notes = createElement('div', {},
                        createElement('label', { className: 'text-xs font-medium' }, 'Notat (f.eks. farge, m√•l)'),
                        createElement('input', { 
                            type: 'text', 
                            value: item.notes, 
                            className: `w-full p-2 rounded-md border ${theme.border} ${theme.cardBg}`,
                            oninput: e => { // oninput f√∂r text
                                const p = q.linkedProducts.find(p => p.id === item.id); // <-- FIX: Use 'q'
                                p.notes = e.target.value;
                                update('linkedProducts', q.linkedProducts); // <-- FIX: Use 'q' (Does not trigger total recalculation)
                            }
                        })
                    );

                    itemRow.append(header, inputs, notes);
                    listEl.append(itemRow);
                });
            };

            const createSection = (title, id, fields) => {
                const isOpen = state.openSections[id];
                const header = createElement('h3', { 
                    className: 'text-lg font-semibold flex justify-between items-center cursor-pointer',
                    onclick: () => {
                        state.openSections[id] = !state.openSections[id];
                        const content = document.getElementById(`accordion-content-${id}`);
                        const icon = document.getElementById(`accordion-icon-${id}`);
                        content.classList.toggle('is-open', state.openSections[id]);
                        icon.classList.toggle('is-open', state.openSections[id]);
                    }
                }, title, createElement('span', { id: `accordion-icon-${id}`, className: `accordion-icon ${isOpen ? 'is-open' : ''}`, innerHTML: icons.chevronDown('w-6 h-6') }));
                const content = createElement('div', { id: `accordion-content-${id}`, className: `accordion-content ${isOpen ? 'is-open' : ''}` },
                    createElement('div', {className:'grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4'}, ...fields)
                );
                return createElement('div', {className: `border-b ${theme.border} pb-6`}, header, content);
            };
            
            // FIKS: La til manglende funksjoner
            const customCostsSection = () => {
                const container = createElement('div', { className: 'sm:col-span-2' });
                const list = createElement('div', { className: 'space-y-2' });
                
                (q.customCosts || []).forEach((cost, index) => {
                    const item = createElement('div', { className: `grid grid-cols-1 md:grid-cols-[1fr,100px,100px,auto] gap-2 p-2 rounded-lg ${theme.inputBg}` });
                    item.append(
                        createElement('input', { type: 'text', value: cost.description, placeholder: 'Beskrivelse', className: `w-full p-2 rounded-md border ${theme.border} ${theme.cardBg}`, oninput: e => { q.customCosts[index].description = e.target.value; update('customCosts', q.customCosts); } }),
                        createElement('input', { type: 'number', value: cost.amount, placeholder: 'Bel√∏p', className: `w-full p-2 rounded-md border ${theme.border} ${theme.cardBg}`, onchange: e => { q.customCosts[index].amount = Number(e.target.value); update('customCosts', q.customCosts); } }),
                        createElement('input', { type: 'number', value: cost.vatRate, placeholder: 'Mva %', className: `w-full p-2 rounded-md border ${theme.border} ${theme.cardBg}`, onchange: e => { q.customCosts[index].vatRate = Number(e.target.value); update('customCosts', q.customCosts); } }),
                        createElement('button', { innerHTML: icons.trash('w-5 h-5 text-red-500'), className: 'p-2', onclick: () => { q.customCosts.splice(index, 1); update('customCosts', q.customCosts); } })
                    );
                    list.append(item);
                });
                
                const addButton = createElement('button', { 
                    type: 'button', 
                    className: `text-sm font-semibold ${theme.accent} mt-2 flex items-center gap-1`,
                    onclick: () => { 
                        const newCosts = [...(q.customCosts || []), { description: '', amount: 0, vatRate: 25 }];
                        update('customCosts', newCosts); 
                    }
                }, createElement('div', { innerHTML: icons.plus('w-4 h-4') }), 'Legg til ekstra kostnad');
                
                container.append(list, addButton);
                return createSection('Ekstra kostnader', 'customCosts', [container]);
            };
            
            const staffSection = () => {
                const container = createElement('div', { className: 'sm:col-span-2' });
                const grid = createElement('div', { className: 'grid grid-cols-2 md:grid-cols-3 gap-2' });
                
                state.staff.forEach(staff => {
                    const isChecked = (q.assignedStaff || []).includes(staff.id);
                    const label = createElement('label', { className: `flex items-center gap-2 p-3 rounded-lg border ${isChecked ? `border-amber-500 ${theme.accent} ${theme.inputBg}` : `${theme.border} ${theme.cardBg}`}` });
                    const checkbox = createElement('input', { 
                        type: 'checkbox', 
                        checked: isChecked,
                        className: 'rounded text-amber-500 focus:ring-amber-500',
                        onchange: e => {
                            let updatedStaff = [...(q.assignedStaff || [])];
                            if (e.target.checked) {
                                updatedStaff.push(staff.id);
                            } else {
                                updatedStaff = updatedStaff.filter(id => id !== staff.id);
                            }
                            update('assignedStaff', updatedStaff);
                        }
                    });
                    label.append(checkbox, createElement('span', { className: 'font-medium' }, staff.name));
                    grid.append(label);
                });
                
                container.append(grid);
                return createSection('Tildel Mont√∂rer', 'staff', [container]);
            };

            const internalNotesSection = () => createSection('Interne Notater', 'internal', [ createTextarea('internalComment', 'Notater (kun synlig internt)') ]);
            // --- SLUTT P√Ö MANGLENDE FUNKSJONER ---

            const projectSummarySection = renderProjectSummary(q, theme, createSection); // <-- FIX: Pass createSection
            // --- NYTT: L√§gg till ett ID f√∂r Hotswap ---
            const projectSummaryWrapper = createElement('div', { id: 'project-summary-section' }, projectSummarySection); // <-- FIX: Anv√§nd wrapper

            const formWrapper = createElement('div', { className: 'flex-grow overflow-y-auto p-4 md:p-6 space-y-6' },
                createSection('Kunde & Montering', 'info', [
                    // --- START A1 IMPLEMENTATION REFINEMENT (Make Project ID editable/linkable) ---
                    createProjectLinkerField('projectId', 'Tilknyttet Projekt (Rediger for √• flytte/l√§nke tilbudet)'), // <-- FIX: Tydeligere label
                    // --- END A1 IMPLEMENTATION REFINEMENT ---
                    createField('customer', 'Kundenavn'),
                    // --- MODIFISERT: Fjernet redundant Emne-felt fra skjemaet ---
                    // createField('emne', 'Emne', 'text', true), // <-- NYTT: Emne-felt i modal (full bredde)
                    // --- SLUTT MODIFISERING ---
                    createField('contactPerson', 'Kontaktperson'),
                    createField('customerType', 'KundeType'),
                    createField('customerIdNumber', 'Org/Personnummer'),
                    createField('contactEmail', 'E-post', 'email'),
                    createField('contactPhone', 'Telefon', 'tel'),
                    createField('address', 'Adresse', 'text', true),
                    createField('installationDate', 'Monteringsdato', 'date'),
                    // --- MODIFISERT: Fjernet 'Starttid' ---
                    // createField('installationStartTime', 'Starttid', 'time'),
                    // --- SLUTT MODIFISERING ---
                    // --- MODIFISERT: Byttet Sluttid (time) med Sluttdato (date) ---
                    createField('installationEndDate', 'Sluttdato', 'date'),
                    // --- SLUTT MODIFISERING ---
                    // --- REMOVED FIELDS START ---
                    // createField('sentDate', 'Tilbud sendt', 'text', false, true),
                    // createField('approvedDate', 'Prosjekt godkjent', 'text', false, true)
                    // --- REMOVED FIELDS END ---
                ]),
                // --- NY PROJEKTSAMMANFATTNING H√ÑR ---
                projectSummaryWrapper, // <-- FIX: Anv√§nd wrapper
                // ------------------------------------
                // --- UPPDATERAD PRODUKTSEKTION ---
                createSection('Produkt & Pris', 'product', [
                    createLinkedProductsFields(),
                    createTextarea('customerRequests', 'Kundens √∏nsker')
                ]),
                createSection('Mont√∏rer & Kostnader', 'costs', [
                    createField('numInstallers', 'Antall mont√∂rer', 'number'),
                    createField('installerCost', 'Mont√∏rkostnad', 'number'),
                    createField('discountAmount', 'Rabatt', 'number', true)
                ]),
                 customCostsSection(),
                 staffSection(),
                 internalNotesSection(),
                 createElement('div', {className:'sm:col-span-2'}, createElement('p', {className:`text-xs ${theme.textSecondary}`}, `Tilbud ID: ${q.id}`))
            );

            const footer = createElement('footer', { className: `flex-shrink-0 border-t ${theme.border} p-4` },
                createElement('div', { className: 'flex justify-between items-center' },
                    createElement('div', { className: 'hidden md:flex items-baseline gap-2' }, 
                        createElement('span', { className: 'text-lg font-semibold' }, 'Total:'), 
                        createElement('span', { id: 'modal-total-price', className: `text-2xl font-bold ${theme.accent}` }, `${calculatePriceDetails(q).total.toLocaleString('no-NO')} kr`)
                    ),
                    createElement('div', {className:'md:hidden'}, createElement('button', {className:`p-2 ${theme.buttonSecondaryBg} rounded-lg`, innerHTML:icons.chevronUp('w-5 h-5 footer-chevron' + (state.isModalFooterCollapsed ? ' is-collapsed' : '')), onclick: e => {
                        e.stopPropagation();
                        setState({isModalFooterCollapsed: !state.isModalFooterCollapsed});
                    }})),
                    createElement('div', { className: 'flex gap-2' },
                        createElement('button', { 
                            className: `px-4 py-3 rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover} ${theme.text} font-semibold transition-all-smooth btn-interaction`, 
                            onclick: closeModal 
                        }, 'Avbryt'),
                        createElement('button', { 
                            className: `px-4 py-3 rounded-lg ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText} ${theme.buttonPrimaryHover} font-semibold transition-all-smooth btn-interaction`, 
                            onclick: async () => {
                                try {
                                    const payload = transformPortalQuoteToN8nQuote(state.formData);
                                    const result = await dataService.saveQuote(payload);
                                    
                                    const updatedQuote = { ...state.formData, recordId: result.recordId };
                                    const updatedQuotes = state.quotes.map(quote => quote.id === updatedQuote.id ? updatedQuote : quote);
                                    
                                    if (!state.quotes.find(quote => quote.id === updatedQuote.id)) {
                                        updatedQuotes.push(updatedQuote);
                                    }
                                    
                                    setState({ quotes: updatedQuotes, selectedQuoteId: null, formData: null, openSections: {} });
                                    showToast(t('toast.saved', { id: updatedQuote.id }), 'success');
                                } catch (error) {
                                    console.error("Feil ved lagring:", error);
                                    showToast('Lagring feilet. ' + error.message, 'error');
                                }
                            } 
                        }, 'Lagre')
                    )
                )
            );
            
            const mobileFooter = createElement('footer', { className: `collapsible-footer ${state.isModalFooterCollapsed ? 'is-collapsed' : ''} md:hidden flex-shrink-0 border-t ${theme.border} p-4` },
                createElement('div', { className: 'flex items-baseline justify-center gap-2' }, 
                    createElement('span', { id: 'mobile-total-price', className: `text-xl font-bold ${theme.accent}` }, `Totalt: ${calculatePriceDetails(q).total.toLocaleString('no-NO')} kr`)
                )
            );
            
            const modalContent = createElement('div', { 
                className: `w-full max-h-full md:max-w-2xl lg:max-w-3xl ${theme.cardBg} flex flex-col shadow-2xl rounded-t-2xl md:rounded-2xl animate-slide-in-up md:animate-fade-in-scale`,
                style: { pointerEvents: 'auto' },
                onclick: e => e.stopPropagation()
            }, header, formWrapper, mobileFooter, footer);
            
            modalPositioner.append(modalContent);
            fragment.append(modalPositioner);
            
            // NYTT: M√•ste anropa denna *efter* att modalen √§r i DOM:en
            setTimeout(() => renderLinkedProductsList(theme, q, update), 0);

            return fragment;
        }

        function renderTimePicker() {
            const theme = themes[state.theme];
            const targetKey = state.timePickerTarget;
            const currentTime = state.formData[targetKey] || '08:00';
            const [currentHour, currentMinute] = currentTime.split(':').map(Number);
            
            const hours = Array.from({ length: 24 }, (_, i) => i.toString().padStart(2, '0'));
            const minutes = Array.from({ length: 12 }, (_, i) => (i * 5).toString().padStart(2, '0'));
            
            const createColumn = (items, id, currentValue) => {
                const col = createElement('div', { id, className: 'w-1/2 h-48 overflow-y-auto hide-scrollbar time-picker-column' });
                items.forEach(item => {
                    col.append(createElement('div', { className: 'flex items-center justify-center text-lg' }, item));
                });
                
                setTimeout(() => {
                    const selected = items.indexOf(currentValue.toString().padStart(2, '0'));
                    if(selected !== -1) col.scrollTop = selected * 40;
                }, 0);
                
                return col;
            };
            
            const hourCol = createColumn(hours, 'hour-col', currentHour);
            const minCol = createColumn(minutes, 'min-col', currentMinute);
            
            const onSave = () => {
                const hourIndex = Math.round(hourCol.scrollTop / 40);
                const minIndex = Math.round(minCol.scrollTop / 40);
                const newTime = `${hours[hourIndex]}:${minutes[minIndex]}`;
                setState({ formData: { ...state.formData, [targetKey]: newTime }, isTimePickerOpen: false, timePickerTarget: null });
            };
            
            return createElement('div', { 
                className: `fixed inset-0 z-50 ${theme.modalOverlay} animate-fade-in-fast flex items-center justify-center p-4`,
                onclick: () => setState({ isTimePickerOpen: false, timePickerTarget: null })
            }, createElement('div', { className: `w-full max-w-xs ${theme.cardBg} rounded-xl shadow-2xl animate-fade-in-scale`, onclick: e => e.stopPropagation() },
                createElement('div', { className: 'flex p-4' }, hourCol, minCol),
                createElement('div', { className: `p-4 border-t ${theme.border} flex justify-end` },
                    createElement('button', { 
                        className: `px-4 py-2 rounded-lg ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText} ${theme.buttonPrimaryHover} font-semibold`,
                        onclick: onSave
                    }, 'Velg')
                )
            ));
        }
        
        function renderGlobalStatusChanger(target, modalFormData) { // <-- MODIFISERT (tar emot modalFormData)
            if (!state.isModalStatusOpen || !target) return; // <-- MODIFISERT (kollar target)
            const theme = themes[state.theme];
            const q = modalFormData; // <-- FIX: Use passed-in modal data, not global state
            const statuses = ['utkast', 'f√∂rslag-skickat', 'godk√§nd', 'genomf√∂rd', 'betald', 'f√∂rlorad', 'arkiverad'];
            
            const rect = target; // <-- MODIFISERT: M√•let er n√• rect-objektet
            
            const menu = createElement('div', { 
                id: 'global-card-status-menu', 
                className: `fixed w-56 ${theme.cardBg} rounded-lg shadow-xl border ${theme.border} z-40 animate-fade-in-fast`, // <-- MODIFISERT (z-20 -> z-40)
                style: { 
                    top: `${rect.bottom + 5}px`, 
                    left: `${rect.left}px` 
                } // <-- NY (l√§gger till position)
            });
            statuses.forEach(status => {
                const isSelected = q.status === status;
                menu.append(createElement('a', { 
                    href: '#', 
                    className: `block px-4 py-2 text-sm ${theme.text} hover:bg-slate-100 dark:hover:bg-slate-700 ${isSelected ? 'font-bold' : ''}`, 
                    onclick: (e) => { 
                        e.preventDefault(); 
                        q.status = status; // <-- FIX: Mutate the 'q' object directly
                        setState({ isModalStatusOpen: false, modalStatusMenuTarget: null }); // <-- MODIFISERT (rensar target)
                    } 
                }, t(`status.${status}`)));
            });
            
            // --- NYTT: Lagt til ekstra funksjoner ---
            menu.append(createElement('hr', { className: `my-1 ${theme.border}` }));
             
             // Dupliser
             menu.append(createElement('a', { 
                href: '#', 
                className: `block px-4 py-2 text-sm ${theme.text} hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-2`, 
                innerHTML: icons.duplicate('w-4 h-4') + 'Kopier',
                onclick: async (e) => { 
                    e.preventDefault();
                    const newId = `PS-${Date.now()}`;
                    // Bruk state.formData som kilde
                    const newQuote = {...q, id: newId, recordId: null, status: 'utkast'}; // <-- 3. CRUD REFACTORING: Avl√§gsnad projectStatus
                    // KRITISK: Beh√•ll samma projectId vid duplicering
                    newQuote.projectId = q.projectId; 
                    try {
                        const payload = transformPortalQuoteToN8nQuote(newQuote);
                        const result = await dataService.saveQuote(payload);
                        const finalQuote = { ...newQuote, recordId: result.recordId };
                        
                        // --- 3. CRUD REFACTORING: L√§gg till quoteId i existerande projekt ---
                        const updatedProjects = state.projects.map(p => {
                            if (p.projectId === finalQuote.projectId) {
                                return { ...p, quoteIds: [...(p.quoteIds || []), finalQuote.id] };
                            }
                            return p;
                        });
                        // --- SLUTT NY LOGIK ---
                        
                        setState({ quotes: [finalQuote, ...state.quotes], projects: updatedProjects, openCardMenu: {id: null, target: null} }); // <-- 3. CRUD REFACTORING: Spara projects
                        showToast(t('toast.copied'), 'success');
                    } catch (error) {
                        console.error("Feil ved kopiering:", error);
                        showToast('Kunne inte kopiere.', 'error');
                    }
                }
             }));
             
             // Send
             menu.append(createElement('a', { 
                href: '#', 
                className: `block px-4 py-2 text-sm ${theme.text} hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-2`, 
                innerHTML: icons.mail('w-4 h-4') + 'Send tilbud',
                onclick: (e) => { 
                    e.preventDefault();
                    setState({ isConfirmModalOpen: true, quoteToSend: q, openCardMenu: {id: null, target: null} }); 
                }
             }));
             
             // Slett
             menu.append(createElement('a', { 
                href: '#', 
                className: `block px-4 py-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/50 flex items-center gap-2`, 
                innerHTML: icons.trash('w-4 h-4') + 'Slett',
                onclick: (e) => { 
                    e.preventDefault(); 
                    setState({ isDeleteConfirmModalOpen: true, quoteToDelete: q, openCardMenu: {id: null, target: null} }); 
                } 
             }));
            
            return menu;
        }

        // --- NY FUNKSJON GJAOPPRETTET ---
        function renderCardStatusMenu(quote, target) {
            // Denne funksjonen er spesifikt for kortene p√• dashboardet,
            // ikke for modalen.
            if (!state.openCardMenu.id || !target || state.openCardMenu.id !== quote.id) return;
            
            const theme = themes[state.theme];
            const q = quote; // Bruk det passede tilbudet
            const statuses = ['utkast', 'f√∂rslag-skickat', 'godk√§nd', 'genomf√∂rd', 'betald', 'f√∂rlorad', 'arkiverad'];
            
            const rect = target; 
            
            const menu = createElement('div', { 
                id: 'global-card-status-menu', // ID er ok, den er midlertidig
                className: `fixed w-56 ${theme.cardBg} rounded-lg shadow-xl border ${theme.border} z-20 animate-fade-in-fast`, 
                style: { 
                    top: `${rect.bottom + 5}px`, 
                    left: `${rect.left}px` 
                }
            });

            // --- Statusendrings-lenker ---
            statuses.forEach(status => {
                const isSelected = q.status === status;
                menu.append(createElement('a', { 
                    href: '#', 
                    className: `block px-4 py-2 text-sm ${theme.text} hover:bg-slate-100 dark:hover:bg-slate-700 ${isSelected ? 'font-bold' : ''}`, 
                    onclick: async (e) => { // <-- Gjort async for lagring
                        e.preventDefault();
                        e.stopPropagation(); // Forhindre at kortet klikkes
                        
                        // --- DETTE ER DEN NYE, KORREKTE LOGIKKEN ---
                        const updatedQuote = { ...q, status: status };
                        
                        // 1. Optimistisk UI-oppdatering
                        const updatedQuotes = state.quotes.map(oldQuote => 
                            oldQuote.id === updatedQuote.id ? updatedQuote : oldQuote
                        );
                        setState({ quotes: updatedQuotes, openCardMenu: {id: null, target: null} }); // Re-render

                        // 2. Lagre endringen
                        try {
                            await dataService.saveQuote(transformPortalQuoteToN8nQuote(updatedQuote));
                        } catch (error) {
                            console.error("Feil ved lagring av status fra kort:", error);
                            // Valgfritt: Rull tilbake UI ved feil
                            // setState({ quotes: state.quotes, openCardMenu: {id: null, target: null} });
                            showToast('Kunne ikke lagre status.', 'error');
                        }
                        // --- SLUTT P√Ö NY LOGIKK ---
                    } 
                }, t(`status.${status}`)));
            });
            
            // --- Ekstra menyvalg (Kopiert fra renderGlobalStatusChanger) ---
            menu.append(createElement('hr', { className: `my-1 ${theme.border}` }));
             
             // Dupliser
             menu.append(createElement('a', { 
                href: '#', 
                className: `block px-4 py-2 text-sm ${theme.text} hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-2`, 
                innerHTML: icons.duplicate('w-4 h-4') + 'Kopier',
                onclick: async (e) => { 
                    e.preventDefault();
                    e.stopPropagation();
                    const newId = `PS-${Date.now()}`;
                    const newQuote = {...q, id: newId, recordId: null, status: 'utkast'};
                    newQuote.projectId = q.projectId; 
                    try {
                        const payload = transformPortalQuoteToN8nQuote(newQuote);
                        const result = await dataService.saveQuote(payload);
                        const finalQuote = { ...newQuote, recordId: result.recordId };
                        
                        const updatedProjects = state.projects.map(p => {
                            if (p.projectId === finalQuote.projectId) {
                                return { ...p, quoteIds: [...(p.quoteIds || []), finalQuote.id] };
                            }
                            return p;
                        });
                        
                        setState({ quotes: [finalQuote, ...state.quotes], projects: updatedProjects, openCardMenu: {id: null, target: null} });
                        showToast(t('toast.copied'), 'success');
                    } catch (error) {
                        console.error("Feil ved kopiering:", error);
                        showToast('Kunne inte kopiere.', 'error');
                    }
                }
             }));
             
             // Send
             menu.append(createElement('a', { 
                href: '#', 
                className: `block px-4 py-2 text-sm ${theme.text} hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-2`, 
                innerHTML: icons.mail('w-4 h-4') + 'Send tilbud',
                onclick: (e) => { 
                    e.preventDefault();
                    e.stopPropagation();
                    setState({ isConfirmModalOpen: true, quoteToSend: q, openCardMenu: {id: null, target: null} }); 
                }
             }));
             
             // Slett
             menu.append(createElement('a', { 
                href: '#', 
                className: `block px-4 py-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/50 flex items-center gap-2`, 
                innerHTML: icons.trash('w-4 h-4') + 'Slett',
                onclick: (e) => { 
                    e.preventDefault(); 
                    e.stopPropagation();
                    setState({ isDeleteConfirmModalOpen: true, quoteToDelete: q, openCardMenu: {id: null, target: null} }); 
                } 
             }));
            
            return menu;
        }
        // --- SLUTT P√Ö NY FUNKSJON ---

        function renderFilterStatusMenu(target) {
            if (!state.openCardMenu || state.openCardMenu.id !== 'filter-menu') return;
            const theme = themes[state.theme];
            const rect = target; // <-- MODIFISERT: M√•let er n√• rect-objektet
            
            const menu = createElement('div', { id: 'global-filter-status-menu', className: `fixed w-56 ${theme.cardBg} rounded-lg shadow-xl border ${theme.border} z-20 animate-fade-in-fast`});
            menu.style.top = `${rect.bottom + 5}px`;
            menu.style.left = `${rect.left}px`;
            
            const filters = ['prioriterade', 'aktiva', 'kommande', 'alla'];
            filters.forEach(filter => {
                const isSelected = state.filter === filter;
                menu.append(createElement('a', { 
                    href: '#', 
                    className: `block px-4 py-2 text-sm ${theme.text} hover:bg-slate-100 dark:hover:bg-slate-700 ${isSelected ? 'font-bold' : ''}`, 
                    onclick: (e) => { 
                        e.preventDefault(); 
                        setState({ filter: filter, openCardMenu: {id: null, target: null} }); 
                    } 
                }, t(`filter.${filter}`)));
            });
            return menu;
        }

        function renderConfirmModal() {
            if (!state.isConfirmModalOpen) return;
            const theme = themes[state.theme];
            const q = state.quoteToSend;
            return createElement('div', { className: `fixed inset-0 z-40 ${theme.modalOverlay} animate-fade-in-fast flex items-center justify-center p-4`},
                createElement('div', { className: `w-full max-w-md ${theme.cardBg} rounded-xl shadow-2xl animate-fade-in-scale`},
                    createElement('div', { className: 'p-6' },
                        createElement('div', { className: `mx-auto flex h-12 w-12 items-center justify-center rounded-full ${theme.accent} bg-opacity-10`}, icons.mail('w-6 h-6 ' + theme.accent)),
                        createElement('h3', { className: `mt-3 text-center text-lg font-semibold`}, `Send tilbud til ${q.customer}?`),
                        createElement('p', { className: `mt-2 text-center text-sm ${theme.textSecondary}`}, `Dette vil markere tilbudet som "Sendt" og starte en simulert e-postutveksling.`)
                    ),
                    createElement('footer', { className: `p-4 rounded-b-xl ${theme.bg} flex justify-end gap-2`},
                        createElement('button', { 
                            className: `px-4 py-2 rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover} ${theme.text} font-semibold`, 
                            onclick: () => setState({ isConfirmModalOpen: false, quoteToSend: null }) 
                        }, 'Avbryt'),
                        createElement('button', { 
                            className: `px-4 py-2 rounded-lg ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText} ${theme.buttonPrimaryHover} font-semibold`, 
                            onclick: () => {
                                handleSendProposal(q);
                                setState({ isConfirmModalOpen: false, quoteToSend: null });
                            } 
                        }, 'Ja, send tilbud')
                    )
                )
            );
        }
        
        function renderTemplateEditor() {
            if (!state.isTemplateEditorOpen) return;
            const theme = themes[state.theme];
            
            let editorState = { ...state.productTemplates };

            const renderEditorContent = () => {
                const container = createElement('div', { className: 'space-y-4' });
                
                Object.keys(editorState).forEach(category => {
                    const categoryEl = createElement('div', { className: `p-4 rounded-lg border ${theme.border} ${theme.inputBg}` });
                    const categoryHeader = createElement('div', { className: 'flex justify-between items-center mb-2' });
                    categoryHeader.append(
                        createElement('input', { 
                            type: 'text', 
                            value: category, 
                            className: `text-lg font-bold w-full p-1 -ml-1 rounded ${theme.cardBg}`,
                            onchange: e => {
                                const newCategoryName = e.target.value;
                                if (newCategoryName && !editorState[newCategoryName]) {
                                    editorState[newCategoryName] = editorState[category];
                                    delete editorState[category];
                                    rerender();
                                }
                            }
                        }),
                        createElement('button', { innerHTML: icons.trash('w-5 h-5 text-red-500'), onclick: () => { delete editorState[category]; rerender(); }})
                    );
                    categoryEl.append(categoryHeader);
                    
                    const itemsEl = createElement('div', { className: 'space-y-2' });
                    Object.keys(editorState[category]).forEach(title => {
                        const itemEl = createElement('div', { className: `p-3 rounded ${theme.cardBg} border ${theme.border}` });
                        itemEl.append(
                            createElement('input', { 
                                type: 'text', 
                                value: title, 
                                className: 'font-semibold w-full mb-1',
                                onchange: e => {
                                    const newTitle = e.target.value;
                                    if(newTitle && !editorState[category][newTitle]) {
                                        editorState[category][newTitle] = editorState[category][title];
                                        delete editorState[category][title];
                                        rerender();
                                    }
                                }
                            }),
                            createElement('textarea', { 
                                className: `w-full text-sm ${theme.textSecondary} min-h-[60px]`,
                                onchange: e => { editorState[category][title] = e.target.value; }
                            }, editorState[category][title]),
                            createElement('button', { 
                                innerHTML: icons.trash('w-4 h-4 text-red-500'), 
                                className: 'text-xs mt-1',
                                onclick: () => { delete editorState[category][title]; rerender(); }
                            })
                        );
                        itemsEl.append(itemEl);
                    });
                    
                    itemsEl.append(createElement('button', { 
                        className: `text-sm font-semibold ${theme.accent} mt-2`,
                        onclick: () => { editorState[category][`Ny Mal ${Date.now()}`] = 'Ny beskrivelse...'; rerender(); }
                    }, '+ Legg til mal'));
                    
                    categoryEl.append(itemsEl);
                    container.append(categoryEl);
                });
                
                container.append(createElement('button', { 
                    className: `text-md font-semibold ${theme.accent} mt-4`,
                    onclick: () => { editorState[`Ny Kategori ${Date.now()}`] = {}; rerender(); }
                }, '+ Legg til kategori'));
                
                return container;
            };
            
            const contentWrapper = createElement('div', { className: 'flex-grow overflow-y-auto p-6' });
            
            const rerender = () => {
                contentWrapper.innerHTML = '';
                contentWrapper.append(renderEditorContent());
            };
            rerender(); // Initial render

            return createElement('div', { 
                className: `fixed inset-0 z-40 ${theme.modalOverlay} animate-fade-in-fast flex items-center justify-center p-4`,
                onclick: () => setState({ isTemplateEditorOpen: false })
            }, createElement('div', { 
                className: `w-full max-w-2xl h-[80vh] ${theme.cardBg} rounded-xl shadow-2xl animate-fade-in-scale flex flex-col`, 
                onclick: e => e.stopPropagation() 
            },
                createElement('h3', { className: `p-4 border-b ${theme.border} font-bold text-lg`}, `Administrer Produktmaler`),
                contentWrapper,
                createElement('footer', { className: `p-4 rounded-b-xl ${theme.bg} border-t ${theme.border} flex justify-end gap-2`},
                    createElement('button', { 
                        className: `px-4 py-2 rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover} ${theme.text} font-semibold`, 
                        onclick: () => setState({ isTemplateEditorOpen: false }) 
                    }, 'Avbryt'),
                    createElement('button', { 
                        className: `px-4 py-2 rounded-lg ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText} ${theme.buttonPrimaryHover} font-semibold`, 
                        onclick: () => {
                            localStorage.setItem('prima-product-templates', JSON.stringify(editorState));
                            setState({ productTemplates: editorState, isTemplateEditorOpen: false });
                            showToast(t('toast.templates_saved'), 'success');
                        } 
                    }, 'Lagre maler')
                )
            ));
        }
        
        // FIKS: La til manglende funksjon
        function renderDeleteProductConfirmModal() {
            if (!state.isDeleteProductConfirmOpen) return;
            const theme = themes[state.theme];
            const p = state.productToDelete;
            return createElement('div', { className: `fixed inset-0 z-40 ${theme.modalOverlay} animate-fade-in-fast flex items-center justify-center p-4`},
                createElement('div', { className: `w-full max-w-md ${theme.cardBg} rounded-xl shadow-2xl animate-fade-in-scale`},
                    createElement('div', { className: 'p-6' },
                        createElement('div', { className: `mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100`}, icons.trash('w-6 h-6 text-red-600')),
                        createElement('h3', { className: `mt-3 text-center text-lg font-semibold`}, `Slette produktet?`),
                        createElement('p', { className: `mt-2 text-center text-sm ${theme.textSecondary}`}, `Er du sikker p√• at du vil slette <strong>${p.name}</strong>? Handlingen kan ikke angres.`)
                    ),
                    createElement('footer', { className: `p-4 rounded-b-xl ${theme.bg} flex justify-end gap-2`},
                        createElement('button', { 
                            className: `px-4 py-2 rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover} ${theme.text} font-semibold`, 
                            onclick: () => setState({ isDeleteProductConfirmOpen: false, productToDelete: null }) 
                        }, 'Avbryt'),
                        createElement('button', { 
                            className: `px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 font-semibold`, 
                            onclick: () => handleDeleteProduct(p)
                        }, 'Ja, slett produktet')
                    )
                )
            );
        }

        // --- NY MODAL F√ñR ANSATTE ---
        function renderDeleteStaffConfirmModal() {
            if (!state.isDeleteStaffConfirmOpen) return;
            const theme = themes[state.theme];
            const s = state.staffToDelete;
            return createElement('div', { className: `fixed inset-0 z-40 ${theme.modalOverlay} animate-fade-in-fast flex items-center justify-center p-4`},
                createElement('div', { className: `w-full max-w-md ${theme.cardBg} rounded-xl shadow-2xl animate-fade-in-scale`},
                    createElement('div', { className: 'p-6' },
                        createElement('div', { className: `mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100`}, icons.trash('w-6 h-6 text-red-600')),
                        createElement('h3', { className: `mt-3 text-center text-lg font-semibold`}, `Slette ansatt?`),
                        createElement('p', { className: `mt-2 text-center text-sm ${theme.textSecondary}`}, `Er du sikker p√• at du vil slette <strong>${s.name}</strong>? Handlingen kan ikke angres.`)
                    ),
                    createElement('footer', { className: `p-4 rounded-b-xl ${theme.bg} border-t ${theme.border} flex justify-end gap-2`},
                        createElement('button', { 
                            className: `px-4 py-2 rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover} ${theme.text} font-semibold`, 
                            onclick: () => setState({ isDeleteStaffConfirmOpen: false, staffToDelete: null }) 
                        }, 'Avbryt'),
                        createElement('button', { 
                            className: `px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 font-semibold`, 
                            onclick: () => handleDeleteStaff(s)
                        }, 'Ja, slett ansatt')
                    )
                )
            );
        }

        // --- NY MODAL F√ñR ANSATTE ---
        function renderStaffModal() {
            if (!state.staffToEdit) return;
            const theme = themes[state.theme];
            const s = state.staffToEdit;
            let formData = { ...s };

            const update = (key, value) => {
                formData[key] = value;
            };

            const createField = (key, label, type = 'text') => {
                const input = createElement('input', {
                    type,
                    value: formData[key] || '',
                    className: `w-full p-3 rounded-lg border ${theme.border} ${theme.inputBg}`,
                    oninput: e => update(key, e.target.value)
                });
                return createElement('div', {}, createElement('label', { className: 'block text-sm font-medium mb-1' }, label), input);
            };

            const footerButtons = [
                createElement('button', {
                    className: `px-4 py-2 rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover} ${theme.text} font-semibold`,
                    onclick: () => setState({ staffToEdit: null })
                }, 'Avbryt'),
                createElement('button', {
                    className: `px-4 py-2 rounded-lg ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText} ${theme.buttonPrimaryHover} font-semibold`,
                    onclick: () => handleSaveStaff(formData)
                }, 'Lagre Ansatt')
            ];

            if (s.id) {
                // Legg til Slett-knapp hvis vi redigerer
                footerButtons.unshift(createElement('button', {
                    className: `px-4 py-2 rounded-lg bg-red-100 text-red-700 hover:bg-red-200 dark:bg-red-900/50 dark:text-red-300 dark:hover:bg-red-900/80 font-semibold mr-auto`,
                    onclick: () => setState({ isDeleteStaffConfirmOpen: true, staffToDelete: s, staffToEdit: null })
                }, 'Slett'));
            }

            return createElement('div', {
                className: `fixed inset-0 z-40 ${theme.modalOverlay} animate-fade-in-fast flex items-center justify-center p-4`,
                onclick: () => setState({ staffToEdit: null })
            }, createElement('div', {
                className: `w-full max-w-md ${theme.cardBg} rounded-xl shadow-2xl animate-fade-in-scale flex flex-col`,
                onclick: e => e.stopPropagation()
            },
                createElement('h3', { className: `p-4 border-b ${theme.border} font-bold text-lg` }, s.id ? 'Rediger Ansatt' : 'Ny Ansatt'),
                createElement('div', { className: 'p-6 grid grid-cols-1 gap-4' },
                    createField('name', 'Navn'),
                    createField('role', 'Rolle/Stilling')
                    // Flere felt (epost, tlf) kan legges til her senere
                ),
                createElement('footer', { className: `p-4 rounded-b-xl ${theme.bg} border-t ${theme.border} flex justify-end gap-2` },
                    ...footerButtons
                )
            ));
        }

        // FIKS: La til manglende funksjon
        function renderProductModal() {
            if (!state.productToEdit) return;
            const theme = themes[state.theme];
            const p = state.productToEdit;
            let formData = { ...p };

            const update = (key, value) => {
                formData[key] = value;
            };

            const createField = (key, label, type = 'text') => {
                const input = createElement('input', {
                    type,
                    value: formData[key] || '',
                    className: `w-full p-3 rounded-lg border ${theme.border} ${theme.inputBg}`,
                    oninput: e => update(key, e.target.value)
                });
                return createElement('div', {}, createElement('label', { className: 'block text-sm font-medium mb-1' }, label), input);
            };

            const createSelect = (key, label, options) => {
                const select = createElement('select', {
                    className: `w-full p-3 rounded-lg border ${theme.border} ${theme.inputBg}`,
                    onchange: e => update(key, e.target.value)
                });
                options.forEach(opt => {
                    select.append(createElement('option', { value: opt.value, selected: formData[key] === opt.value }, opt.label));
                });
                return createElement('div', {}, createElement('label', { className: 'block text-sm font-medium mb-1' }, label), select);
            };

            const createTextarea = (key, label) => createElement('div', { className: 'sm:col-span-2' }, createElement('label', { className: 'block text-sm font-medium mb-1' }, label), createElement('textarea', { oninput: e => update(key, e.target.value), className: `w-full p-3 rounded-lg border ${theme.border} ${theme.inputBg} min-h-[100px]` }, formData[key] || ''));

            return createElement('div', {
                className: `fixed inset-0 z-40 ${theme.modalOverlay} animate-fade-in-fast flex items-center justify-center p-4`,
                onclick: () => setState({ productToEdit: null })
            }, createElement('div', {
                className: `w-full max-w-lg ${theme.cardBg} rounded-xl shadow-2xl animate-fade-in-scale flex flex-col`,
                onclick: e => e.stopPropagation()
            },
                createElement('h3', { className: `p-4 border-b ${theme.border} font-bold text-lg` }, p.id ? 'Rediger Produkt' : 'Nytt Produkt'),
                createElement('div', { className: 'p-6 grid grid-cols-1 sm:grid-cols-2 gap-4' },
                    createField('name', 'Produktnavn'),
                    createSelect('supplierId', 'Leverand√∏r', state.suppliers.map(s => ({ value: s.id, label: s.name }))),
                    createField('category', 'Kategori'),
                    createField('description', 'Beskrivelse', 'text'),
                ),
                createElement('footer', { className: `p-4 rounded-b-xl ${theme.bg} border-t ${theme.border} flex justify-end gap-2` },
                    createElement('button', {
                        className: `px-4 py-2 rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover} ${theme.text} font-semibold`,
                        onclick: () => setState({ productToEdit: null })
                    }, 'Avbryt'),
                    createElement('button', {
                        className: `px-4 py-2 rounded-lg ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText} ${theme.buttonPrimaryHover} font-semibold`,
                        onclick: () => handleSaveProduct(formData)
                    }, 'Lagre Produkt')
                )
            ));
        }

        // FIKS: La til manglende funksjon
        function renderFallback() {
            const appRoot = document.getElementById('app-root');
            if (appRoot) {
                appRoot.innerHTML = `
                    <div class="min-h-screen bg-slate-50 flex items-center justify-center">
                        <div class="text-center">
                            <h1 class="text-2xl font-bold text-slate-800">Prima Portal</h1>
                            <p class="text-slate-600 mt-2">Initialiserar system...</p>
                            <div class="mt-4">
                                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function showToast(message, type = 'info') {
            const theme = themes[state.theme];
            const oldToast = document.getElementById('toast-notification');
            if (oldToast) oldToast.remove();
            
            let bgColor, textColor, icon;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100 dark:bg-green-900';
                    textColor = 'text-green-700 dark:text-green-200';
                    icon = icons.check('w-5 h-5');
                    break;
                case 'error':
                    bgColor = 'bg-red-100 dark:bg-red-900';
                    textColor = 'text-red-700 dark:text-red-200';
                    icon = icons.warning('w-5 h-5');
                    break;
                default:
                    bgColor = 'bg-blue-100 dark:bg-blue-900';
                    textColor = 'text-blue-700 dark:text-blue-200';
                    icon = icons.check('w-5 h-5'); // FIKS: Byttet fra icons.info (som ikke fantes)
            }

            const toast = createElement('div', { 
                id: 'toast-notification', 
                className: `fixed bottom-5 right-5 z-50 ${theme.cardBg} ${bgColor} ${textColor} p-4 rounded-lg shadow-lg flex items-center gap-3 animate-fade-in-fast`
            });
            toast.innerHTML = icon;
            toast.append(createElement('span', { className: 'font-medium' }, message));
            
            document.body.append(toast);
            
            setTimeout(() => {
                toast.classList.add('animate-fade-out-fast');
                toast.addEventListener('animationend', () => toast.remove());
            }, 3000);
        }

        const getStatusPillStyles = (status, theme) => {
            switch (status) {
                case 'utkast': return `bg-slate-200 ${theme.textSecondary} dark:bg-slate-700`;
                case 'f√∂rslag-skickat': return 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300';
                case 'godk√§nd': return 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300';
                case 'genomf√∂rd': return 'bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300';
                case 'betald': return 'bg-green-200 text-green-800 dark:bg-green-800 dark:text-green-200';
                case 'f√∂rlorad': return 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300';
                case 'arkiverad': return `bg-slate-100 ${theme.textSecondary} dark:bg-slate-800`;
                default: return `bg-slate-200 ${theme.textSecondary} dark:bg-slate-700`;
            }
        };

        const createElement = (tag, props, ...children) => {
            const el = document.createElement(tag);
            if (props) {
                Object.keys(props).forEach(key => {
                    if (key.startsWith('on') && typeof props[key] === 'function') {
                        el.addEventListener(key.substring(2).toLowerCase(), props[key]);
                    } else if (key === 'className') {
                        el.className = props[key];
                    } else if (key === 'innerHTML') {
                        el.innerHTML = props[key];
                    } else if (key === 'style' && typeof props[key] === 'object') {
                        Object.assign(el.style, props[key]);
                    } else {
                        el.setAttribute(key, props[key]);
                    }
                });
            }
            children.forEach(child => {
                if (typeof child === 'string') {
                    el.appendChild(document.createTextNode(child));
                } else if (child instanceof HTMLElement || child instanceof DocumentFragment) {
                    el.appendChild(child);
                }
            });
            return el;
        };
        
        // FIKS: La til manglende funksjon
        function createProductCard(p, theme) {
            const supplier = state.suppliers.find(s => s.id === p.supplierId);
            return createElement('div', { className: `overflow-hidden rounded-xl border ${theme.border} ${theme.cardBg} flex flex-col` },
                createElement('div', { className: 'p-5' },
                    createElement('h3', { className: 'text-lg font-bold' }, p.name),
                    createElement('p', { className: `text-sm ${theme.textSecondary} mt-1` }, p.category),
                    createElement('p', { className: 'mt-3 text-sm' }, p.description)
                ),
                createElement('div', { className: `mt-auto p-4 border-t ${theme.border} ${theme.bg} flex justify-between items-center` },
                    createElement('span', { className: 'text-sm' }, supplier ? `Leverand√∏r: ${supplier.name}` : 'Ukjent leverand√∏r'),
                    createElement('div', { className: 'flex gap-2' },
                        createElement('button', {
                            className: `p-2 ${theme.buttonSecondaryBg} rounded-lg transition-all-smooth btn-interaction`,
                            innerHTML: icons.pencil('w-4 h-4'),
                            onclick: () => setState({ productToEdit: { ...p } })
                        }),
                        createElement('button', {
                            className: `p-2 ${theme.buttonSecondaryBg} rounded-lg transition-all-smooth btn-interaction`,
                            innerHTML: icons.trash('w-4 h-4 text-red-500'),
                            onclick: () => setState({ isDeleteProductConfirmOpen: true, productToDelete: p })
                        })
                    )
                )
            );
        }

        // FIKS: La til manglende funksjon
        function renderProductsPage() {
            const theme = themes[state.theme];

            // --- NYTT: Filter- og s√∏kefelt ---
            const searchInput = createElement('input', {
                type: 'text',
                placeholder: 'S√∏k etter produktnavn...',
                className: `w-full md:w-64 pl-10 pr-4 py-2 rounded-lg border ${theme.border} ${theme.inputBg}`,
                value: state.productSearchTerm,
                oninput: e => setState({ productSearchTerm: e.target.value })
            });
            const searchWrapper = createElement('div', { className: 'relative' },
                createElement('span', { className: `absolute left-3 top-1/2 -translate-y-1/2 ${theme.textSecondary}`, innerHTML: icons.search('w-5 h-5') }),
                searchInput
            );

            const supplierSelect = createElement('select', {
                className: `w-full md:w-64 p-2 rounded-lg border ${theme.border} ${theme.inputBg}`,
                onchange: e => setState({ productSupplierFilter: e.target.value })
            });
            supplierSelect.append(createElement('option', { value: 'all', selected: state.productSupplierFilter === 'all' }, 'Alle Leverand√∏rer'));
            state.suppliers.forEach(s => {
                supplierSelect.append(createElement('option', { value: s.id, selected: state.productSupplierFilter === s.id }, s.name));
            });
            
            const addProductButton = createElement('button', {
                className: `px-4 py-2 rounded-lg ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText} ${theme.buttonPrimaryHover} font-semibold flex items-center gap-2 transition-all-smooth btn-interaction`,
                innerHTML: icons.plus('w-5 h-5') + 'Legg til Produkt',
                onclick: () => setState({ productToEdit: { name: '', supplierId: state.suppliers[0]?.id || '', category: '', description: '' } })
            });
            
            // --- NY HEADER-LAYOUT ---
            const headerTop = createElement('div', { className: 'flex justify-between items-center mb-4' },
                createElement('h2', { className: 'text-3xl font-bold' }, 'Produktkatalog'),
                addProductButton
            );
            
            const filterBar = createElement('div', { className: 'flex flex-col md:flex-row gap-4 mb-6' },
                searchWrapper,
                supplierSelect
            );
            
            const header = createElement('div', {}, headerTop, filterBar);
            // --- SLUTT NY HEADER ---

            // --- NYTT: Filtreringslogikk ---
            const searchTerm = state.productSearchTerm.toLowerCase();
            const supplierFilter = state.productSupplierFilter;

            const filteredProducts = state.products.filter(p => {
                const nameMatch = p.name.toLowerCase().includes(searchTerm) || p.description.toLowerCase().includes(searchTerm);
                const supplierMatch = supplierFilter === 'all' || p.supplierId === supplierFilter;
                return nameMatch && supplierMatch;
            });
            // --- SLUTT FILTRERING ---
            
            const grid = createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' });
            
            // --- NYTT: Sjekk om filterresultater er tomme ---
            if (filteredProducts.length > 0) {
                filteredProducts.forEach(p => grid.append(createProductCard(p, theme)));
            } else {
                grid.append(createElement('div', { className: `md:col-span-2 lg:col-span-3 text-center p-8 ${theme.inputBg} rounded-lg` },
                    createElement('h3', { className: 'text-lg font-semibold' }, 'Ingen produkter funnet'),
                    createElement('p', { className: `${theme.textSecondary} mt-1` }, 'Pr√∏v √• justere s√∏ke- eller filterkriteriene.')
                ));
            }
            // --- SLUTT ---
            
            return createElement('div', { className: 'p-4 md:p-8' }, header, grid);
        }

        // --- START SURGICAL MODIFICATION 3 (Replace Function) ---
        // Erstatt den eksisterende, tomme renderProjectsPage-funksjonen med denne komplette versjonen
        function renderProjectsPage() {
            const theme = themes[state.theme];
            const container = createElement('div', { className: 'p-4 md:p-8 h-full flex flex-col' }); // S√∏rg for at den fyller h√∏yden

            // Header (denne er n√• korrekt)
            const titleHeader = createElement('div', {},
                createElement('h2', { className: 'text-3xl font-bold' }, t('nav.projects')),
                createElement('p', { className: `text-lg ${theme.textSecondary} mt-1` }, t('projects.subtitle'))
            );
            const addColumnButton = createElement('button', {
                className: `text-sm font-semibold ${theme.accent} flex items-center gap-1 mt-1`,
                innerHTML: icons.plus('w-4 h-4') + 'Legg til kolonne',
                onclick: () => showToast('Legge til kolonne er under utvikling.', 'info') // Placeholder
            });
            const header = createElement('div', { className: 'flex-shrink-0 flex justify-between items-start mb-6' },
                titleHeader,
                addColumnButton
            );

            const board = createElement('div', { className: 'flex-grow flex gap-6 overflow-x-auto pb-4' }); // S√∏rg for at den vokser

            // --- START KIRURGISK ENDRING: Sorter kolonner basert p√• 'order' ---
            const sortedStatuses = Object.entries(state.projectStatuses)
                .sort(([, a], [, b]) => (a.order || 0) - (b.order || 0));

            // Gjeninnf√∏r logikken for √• bygge kolonner og kort
            sortedStatuses.forEach(([statusKey, statusObj]) => {
            // --- SLUTT KIRURGISK ENDRING ---
                const column = createElement('div', { className: `kanban-column ${theme.inputBg} rounded-xl p-4 flex-shrink-0` }); // Lagt til flex-shrink-0
                
                // --- START KIRURGISK ENDRING: Legg til cog-knapp ---
                const titleBadge = createElement('span', {
                    className: `px-3 py-1 rounded-full text-xs font-semibold uppercase ${statusObj.bg} ${statusObj.text}`
                }, statusObj.name);

                const settingsButton = createElement('button', {
                    className: `p-1 rounded-full text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all-smooth`,
                    title: 'Rediger kolonne',
                    onclick: () => {
                        setState({ isEditingColumn: statusKey });
                    }
                });
                settingsButton.innerHTML = icons.cog('w-4 h-4');
                
                const columnHeader = createElement('div', { className: 'mb-4 flex justify-between items-center' },
                    titleBadge,
                    settingsButton
                );
                column.append(columnHeader);
                // --- SLUTT KIRURGISK ENDRING ---

                const cardContainer = createElement('div', {
                    className: 'space-y-4 min-h-[400px] p-2 rounded-lg transition-colors',
                    'data-status': statusKey,
                    ondragover: e => {
                        e.preventDefault();
                        e.currentTarget.classList.add('drag-over', theme.border);
                    },
                    ondragenter: e => e.currentTarget.classList.add('drag-over', theme.border),
                    ondragleave: e => e.currentTarget.classList.remove('drag-over', theme.border),
                    ondrop: e => {
                        e.preventDefault();
                        e.currentTarget.classList.remove('drag-over', theme.border);
                        
                        const projectId = e.dataTransfer.getData('text/plain') || window.DRAGGING_PROJECT_ID;
                        const newStatus = e.currentTarget.dataset.status;

                        if (!projectId || !newStatus) {
                            console.error("Drop feilet: Mangler projectId or newStatus.");
                            window.DRAGGING_PROJECT_ID = null;
                            return;
                        }
                        
                        const updatedProjects = state.projects.map(p =>
                            p.projectId === projectId ? { ...p, projectStatus: newStatus } : p
                        );
                        setState({ projects: updatedProjects });
                        
                        window.DRAGGING_PROJECT_ID = null;
                    }
                });

// ... i funksjonen renderProjectsPage() ...
                state.projects.filter(p => p.projectStatus === statusKey).forEach(p => {
                    // Hent info for kortet
                    const primaryQuote = state.quotes.find(q => q.projectId === p.projectId);
                    // Hvis et prosjekt av en eller annen grunn ikke har tilbud, ikke render kortet
                    if (!primaryQuote) {
                         console.warn(`Prosjekt ${p.projectId} har ingen tilknyttede tilbud, hopper over rendering.`);
                         return; 
                    }
                    
                    // Beregn totalpris for prosjektet ved √• summere alle tilknyttede tilbud
                    const projectTotal = state.quotes
                        .filter(q => q.projectId === p.projectId)
                        .reduce((sum, q) => sum + (q.total || 0), 0);
                        
                    // Bruk data fra prosjektobjektet
                    const customerName = p.customerName || 'Ukjent Kunde';
                    const address = p.address || 'Ukjent Adresse';

                    // --- NYTT KORT-DESIGN (BASERT P√Ö SKJERMDUMP) ---
                    const card = createElement('div', {
                        className: `${theme.cardBg} border ${theme.border} rounded-xl p-4 cursor-pointer card-interaction`,
                        draggable: true,
                        id: p.projectId,
                        ondragstart: e => {
                            e.dataTransfer.setData('text/plain', e.target.id);
                            e.dataTransfer.effectAllowed = 'move';
                            window.DRAGGING_PROJECT_ID = e.target.id;
                            e.target.classList.add('dragging');
                        },
                        ondragend: e => e.target.classList.remove('dragging'),
                        onclick: () => {
                            // √ÖPNE DEN NYE PROSJEKT-MODALEN
                            setState({ selectedProjectId: p.projectId });
                        }
                    });

                    const cardHeader = createElement('div', { className: 'flex justify-between items-start' });
                    const title = createElement('h4', { className: 'font-bold flex-grow pr-2 truncate' }, customerName);
                    
                    // --- START KIRURGISK UTBYGGING: Funksjonell prosjektmeny ---
                    // Erstatt den gamle 'menuButton' med denne
                    const menuButton = createElement('button', {
                        className: `p-1 rounded-full text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all-smooth`,
                        title: 'Prosjektmeny',
                        onclick: (e) => {
                            e.stopPropagation();
                            // Lukk alle andre menyer
                            document.querySelectorAll('#global-card-status-menu, #global-filter-status-menu, .project-status-menu, #modal-product-search-menu, #modal-project-linker-menu').forEach(m => m.remove());

                            const targetRect = e.currentTarget.getBoundingClientRect();
                            const menu = createElement('div', {
                                className: `project-status-menu fixed w-48 ${theme.cardBg} rounded-lg shadow-lg border ${theme.border} z-50 animate-fade-in-fast`,
                                style: { 
                                    top: `${targetRect.bottom + 5}px`, 
                                    // Posisjoner menyen til venstre for knappen
                                    left: `${Math.max(10, targetRect.left - 192 + targetRect.width)}px` 
                                }
                            });
                            
                            // Legg til status-valg
                            menu.append(createElement('div', { className: `px-4 py-2 text-xs font-semibold uppercase ${theme.textSecondary}` }, 'Bytt Status'));
                            Object.entries(state.projectStatuses).forEach(([sKey, sObj]) => {
                                menu.append(createElement('a', {
                                    href: '#',
                                    className: `block px-4 py-2 text-sm ${theme.text} hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer ${p.projectStatus === sKey ? 'font-bold' : ''}`,
                                    onclick: (ev) => {
                                        ev.preventDefault();
                                        ev.stopPropagation();
                                        const updatedProjects = state.projects.map(proj =>
                                            proj.projectId === p.projectId ? { ...proj, projectStatus: sKey } : proj
                                        );
                                        setState({ projects: updatedProjects });
                                        menu.remove();
                                        // TODO: Lagre endring til backend
                                    }
                                }, sObj.name));
                            });

                            // Legg til innstillinger (deaktivert)
                            menu.append(createElement('hr', { className: `my-1 ${theme.border}` }));
                            menu.append(createElement('div', {
                                className: `flex items-center gap-2 px-4 py-2 text-sm ${theme.textSecondary} opacity-60`,
                                innerHTML: icons.cog('w-4 h-4') + 'Innstillinger'
                            }));

                            document.body.append(menu);
                        }
                    });
                    menuButton.innerHTML = icons.dotsVertical('w-5 h-5');
                    // --- SLUTT KIRURGISK UTBYGGING ---
                    
                    cardHeader.append(title, menuButton);

                    card.append(
                        cardHeader,
                        createElement('p', { className: `text-sm ${theme.textSecondary} mt-1 truncate` }, address),
                        createElement('div', { className: 'text-xs mt-3 flex justify-between items-center' },
                            createElement('span', { className: `${theme.textSecondary}` }, `${p.quoteIds.length} tilbud i prosjektet`),
                            createElement('span', { className: `font-semibold text-base ${theme.accent}` }, projectTotal.toLocaleString('no-NO') + ' kr')
                        )
                    );
                    // --- SLUTT P√Ö NYTT KORT-DESIGN ---

                    cardContainer.append(card);
                });

                column.append(cardContainer);
                board.append(column);
            });

            container.append(header, board);
            return container;
        }
        // --- END SURGICAL MODIFICATION 3 ---
        
        // FIKS: La til manglende funksjoner
        function renderSuppliersPage() {
            const theme = themes[state.theme];
            const header = createElement('div', { className: 'flex justify-between items-center mb-6' },
                createElement('h2', { className: 'text-3xl font-bold' }, 'Leverand√∏rer')
                // Knapp for √• legge til leverand√∏r kan implementeres h√§r
            );
            
            const grid = createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' });
            state.suppliers.forEach(s => {
                grid.append(createElement('div', { className: `overflow-hidden rounded-xl border ${theme.border} ${theme.cardBg} flex flex-col` },
                    createElement('div', { className: `h-32 ${theme.bg} flex items-center justify-center` },
                        createElement('img', { src: s.logoUrl, className: 'max-h-20 object-contain', onerror: (e) => e.target.style.display = 'none' })
                    ),
                    createElement('div', { className: 'p-5 flex-grow' },
                        createElement('h3', { className: 'text-lg font-bold' }, s.name)
                    ),
                    createElement('div', { className: `mt-auto p-4 border-t ${theme.border} ${theme.bg}` },
                        createElement('a', { 
                            href: s.website, 
                            target: '_blank', 
                            className: `text-sm font-semibold ${theme.accent} flex items-center gap-1`,
                            innerHTML: 'Bes√∏k nettside ' + icons.externalLink('w-4 h-4')
                        })
                    )
                ));
            });
            
            return createElement('div', { className: 'p-4 md:p-8' }, header, grid);
        }

        // FIKS: La til manglende funksjon
        function renderTimeReportingPage() {
            const theme = themes[state.theme];
            return createElement('div', { className: 'p-4 md:p-8' },
                createElement('h2', { className: 'text-3xl font-bold mb-6' }, 'Tidsrapportering'),
                createElement('p', { className: `${theme.textSecondary}` }, 'Denne modulen er under utvikling.')
                // Fremtidig implementasjon av tidsrapportering...
            );
        }

        // FIKS: La til manglende funksjon
        function renderSocialsPage() {
            const theme = themes[state.theme];
            
            const createPostCard = (post) => {
                const staff = state.staff.find(s => s.id === post.staffId);
                return createElement('div', { className: `rounded-xl border ${theme.border} ${theme.cardBg}` },
                    createElement('div', { className: 'p-4 flex items-center gap-3' },
                        createElement('div', { className: `w-10 h-10 rounded-full ${theme.bg} flex items-center justify-center font-bold text-sm ${theme.accent}` }, staff.name.substring(0, 2)),
                        createElement('div', {},
                            createElement('p', { className: 'font-semibold' }, staff.name),
                            createElement('p', { className: `text-xs ${theme.textSecondary}` }, new Date(post.timestamp).toLocaleString('no-NO'))
                        )
                    ),
                    createElement('p', { className: 'px-4 pb-4' }, post.content),
                    post.imageUrl ? createElement('img', { src: post.imageUrl, className: 'w-full h-64 object-cover' }) : '',
                    createElement('div', { className: `p-4 border-t ${theme.border} flex gap-4` },
                        createElement('button', { className: `flex items-center gap-1 ${theme.textSecondary} hover:${theme.text}`, innerHTML: icons.heart('w-5 h-5') + ' Lik' })
                    )
                );
            };
            
            return createElement('div', { className: 'p-4 md:p-8' },
                createElement('h2', { className: 'text-3xl font-bold mb-6' }, 'Intern Feed'),
                createElement('div', { className: 'max-w-xl mx-auto space-y-6' },
                    createElement('div', { className: `rounded-xl border ${theme.border} ${theme.cardBg} p-4` },
                        createElement('textarea', { placeholder: 'Hva skjer, Prima-teamet?', className: `w-full p-2 border-none rounded-lg ${theme.inputBg} min-h-[80px]` }),
                        createElement('div', { className: 'flex justify-between items-center mt-2' },
                            createElement('button', { className: `p-2 ${theme.textSecondary} hover:${theme.text}`, innerHTML: icons.photo('w-5 h-5') }),
                            createElement('button', { className: `px-4 py-2 rounded-lg ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText} ${theme.buttonPrimaryHover} font-semibold`}, 'Publiser')
                        )
                    ),
                    ...state.socialPosts.map(createPostCard)
                )
            );
        }
        
        // FIKS: La til manglende funksjon
        function renderWishlistPage() {
            const theme = themes[state.theme];
            
            const handleVote = (recordId) => {
                const hasVoted = state.userVotes[recordId];
                if (hasVoted) {
                    state.userVotes[recordId] = false;
                    const item = state.wishlistItems.find(w => w.recordId === recordId);
                    if (item) item.votes--;
                } else {
                    state.userVotes[recordId] = true;
                    const item = state.wishlistItems.find(w => w.recordId === recordId);
                    if (item) item.votes++;
                }
                localStorage.setItem('prima-user-votes', JSON.stringify(state.userVotes));
                setState({ userVotes: state.userVotes, wishlistItems: state.wishlistItems });
            };
            
            const statusThemes = {
                'id√©': `bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300`,
                'planerad': `bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300`,
                'under utveckling': `bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300`
            };

            const createWishCard = (wish) => {
                const hasVoted = state.userVotes[wish.recordId];
                return createElement('div', { className: `p-4 ${theme.cardBg} rounded-xl border ${theme.border} flex items-start gap-4`},
                    createElement('button', {
                        className: `flex flex-col items-center justify-center p-2 w-16 rounded-lg border ${hasVoted ? `border-amber-500 ${theme.accent} ${theme.inputBg}` : `${theme.border} ${theme.buttonSecondaryBg}`}`,
                        onclick: () => handleVote(wish.recordId)
                    }, 
                        createElement('div', { innerHTML: hasVoted ? icons.heartFilled('w-6 h-6 ' + theme.accent) : icons.heart('w-6 h-6') }),
                        createElement('span', { className: 'text-sm font-bold' }, wish.votes)
                    ),
                    createElement('div', { className: 'flex-grow' },
                        createElement('h3', { className: 'font-bold text-lg' }, wish.title),
                        createElement('p', { className: `text-sm ${theme.textSecondary} mt-1 mb-2`}, wish.description),
                        createElement('span', { className: `text-xs font-semibold px-2 py-0.5 rounded-full ${statusThemes[wish.status]}` }, wish.status)
                    )
                );
            };

            return createElement('div', { className: 'p-4 md:p-8' },
                createElement('h2', { className: 'text-3xl font-bold mb-2' }, '√ònskeliste & Roadmap'),
                createElement('p', { className: `text-lg ${theme.textSecondary} mb-6 max-w-2xl` }, 'Her kan du se planlagte funksjoner og stemme p√• hva du √∏nsker at vi skal bygge neste gang.'),
                createElement('div', { className: 'max-w-2xl mx-auto space-y-4' },
                    ...state.wishlistItems.sort((a,b) => b.votes - a.votes).map(createWishCard)
                )
            );
        }
        
        // FIKS: La til manglende funksjon
        function renderStaffPage() {
            const theme = themes[state.theme];
            // --- NYTT: Header med knapp ---
            const header = createElement('div', { className: 'flex justify-between items-center mb-6' },
                createElement('h2', { className: 'text-3xl font-bold' }, 'Ansatte'),
                createElement('button', {
                    className: `px-4 py-2 rounded-lg ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText} ${theme.buttonPrimaryHover} font-semibold flex items-center gap-2 transition-all-smooth btn-interaction`,
                    innerHTML: icons.plus('w-5 h-5') + 'Legg til Ansatt',
                    onclick: () => setState({ staffToEdit: { name: '', role: '' } }) // √Öpner modal med tomt objekt
                })
            );
            
            return createElement('div', { className: 'p-4 md:p-8' },
                header, // <-- ENDRING
                createElement('div', { className: 'grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6' },
                    ...state.staff.map(staff => {
                        return createElement('div', { 
                            className: `text-center ${theme.cardBg} p-6 rounded-xl border ${theme.border} card-interaction transition-all-smooth cursor-pointer`, // <-- ENDRING: La til interaksjon
                            onclick: () => setState({ staffToEdit: { ...staff } }) // <-- ENDRING: Gjorde kortet klikkbart
                        },
                            createElement('div', { className: `w-20 h-20 rounded-full ${theme.bg} flex items-center justify-center font-bold text-2xl ${theme.accent} mx-auto mb-4` }, staff.name.substring(0, 2)),
                            createElement('h3', { className: 'font-semibold text-lg truncate' }, staff.name),
                            createElement('p', { className: `text-sm ${theme.textSecondary} truncate` }, staff.role)
                        );
                    })
                )
            );
        }

        // FIKS: La til manglende funksjon
        function renderQuotesPage(theme) {
            const filteredQuotes = getFilteredQuotes();
            
            const createCard = (q) => {
                const details = calculatePriceDetails(q);
                const hasSiblings = getSiblingQuotes(q).length > 0; 

                // --- Emne-elementet (beh√•lls) ---
                const emneElement = createElement('h3', { 
                    // ... (attributes and handlers remain the same) ...
                     className: 'font-bold text-lg p-1 -m-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700 cursor-text transition-all-smooth truncate', 
                    title: 'Klikk for √• redigere emne',
                    innerHTML: q.emne || 'Standardtilbud', 
                     onclick: (e) => {
                        e.stopPropagation(); 
                        const el = e.currentTarget;
                        if (el.contentEditable === 'true') return; 
                        
                        el.contentEditable = 'true';
                        el.focus();
                        el.dataset.originalValue = el.textContent;
                        document.execCommand('selectAll', false, null);
                    },
                    onblur: (e) => {
                        const el = e.currentTarget;
                        el.contentEditable = 'false';
                        el.classList.remove('outline', 'outline-2', 'outline-amber-500'); 
                        const newEmne = el.textContent.trim();
                        
                        if (newEmne === "") { 
                           el.textContent = el.dataset.originalValue;
                           handleCardEmneChange(q, el.dataset.originalValue);
                        } else {
                           el.textContent = newEmne; 
                           handleCardEmneChange(q, newEmne); 
                        }
                    },
                    onfocus: (e) => {
                        e.currentTarget.classList.add('outline', 'outline-2', 'outline-amber-500');
                    },
                    onkeydown: (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault(); 
                            e.currentTarget.blur(); 
                        } else if (e.key === 'Escape') {
                            e.currentTarget.textContent = e.currentTarget.dataset.originalValue; 
                            e.currentTarget.blur(); 
                        }
                    }
                });
                
                // --- PROJEKTBADGE (MODIFISERT FOR NY POSISJON OG INNHOLD) ---
                let projectBadgeElement;
                if (hasSiblings) {
                    projectBadgeElement = createElement('button', {
                        // --- MODIFIED: Fjernet absolute posisjonering, la til margin ---
                        className: `text-xs font-semibold px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors duration-150 mt-2`, // <-- NY STIL
                        // --- END MODIFICATION ---
                        title: `G√• til Prosjekt ${q.projectId}`,
                        onclick: (e) => {
                            e.stopPropagation(); 
                            setState({ activeView: 'projects' });
                            console.log(`Navigerer til prosjekt: ${q.projectId}`);
                        }
                    }, q.projectId); // <-- MODIFIED: Viser projectId i stedet for 'Prosjekt'
                } else {
                    // --- MODIFIED: Lag en tom div for √• beholde h√∏yden hvis det IKKE er en badge ---
                    projectBadgeElement = createElement('div', { className: 'h-10' }); // <-- Gjeninnf√∏r spaceren KUN her
                }
                // --- SLUTT P√Ö MODIFISERING ---


                return createElement('div', { 
                    // --- MODIFIED: Fjernet 'relative' da den ikke lenger trengs for badgen ---
                    className: `flex flex-col ${theme.cardBg} rounded-xl shadow-sm border ${theme.border} overflow-hidden transition-all-smooth card-interaction`, 
                    onclick: () => setState({ selectedQuoteId: q.id, formData: { ...q } })
                },
                    // --- REMOVED: projectBadgeElement fjernet herfra ---
                    createElement('div', { className: 'p-4' }, 
                        createElement('div', { className: 'flex justify-between items-start mb-2' }, 
                            emneElement, 
                            createElement('button', { // Statusknapp
                                // --- FIKS: Gjenopprettet manglende egenskaper for knappen ---
                                className: `flex-shrink-0 px-3 py-1 rounded-full text-xs font-semibold ${getStatusPillStyles(q.status, theme)}`, 
                                onclick: e => {
                                    e.stopPropagation();
                                    const rect = e.currentTarget.getBoundingClientRect(); 
                                    setState({ openCardMenu: { id: q.id, target: rect } }); 
                                }
                                // --- SLUTT P√Ö FIKS ---
                            }, t(`status.${q.status}`), createElement('span', {className:'ml-1'}, '‚ñæ'))
                        ),
                        
                        // --- MODIFIED: Satt inn projectBadgeElement (eller spacer) her ---
                        projectBadgeElement 
                        // --- SLUTT P√Ö MODIFISERING ---
                    ),
                    createElement('div', { className: `mt-auto p-4 border-t ${theme.border} ${theme.bg} flex justify-between items-center` }, 
                        createElement('div', { className: 'flex items-center gap-2' }, 
                            createElement('span', { className: 'text-sm font-semibold' }, formatDate(q.installationDate)),
                        ),
                        createElement('div', { className: 'flex items-center gap-2' }, 
                            createElement('span', { className: `text-lg font-bold ${theme.accent}` }, `${details.total.toLocaleString('no-NO')} kr`)
                        )
                    )
                );
            };
            
            // ... (rest of renderQuotesPage remains the same) ...
             const grid = createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5' },
                ...filteredQuotes.slice(0, state.displayLimit).map(createCard)
            );
            
            // Wrapper and Content divs remain the same
            const wrapper = createElement('div', { className: 'p-4 md:p-8 w-full flex justify-center' });
            const content = createElement('div', { className: 'w-full max-w-7xl' },
                renderDashboardHeader(theme),
                createElement('div', { className: 'mt-6' }, grid),
                filteredQuotes.length > state.displayLimit ? createElement('button', { 
                    className: `w-full mt-6 py-3 rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover} font-semibold`,
                    onclick: () => setState({ displayLimit: state.displayLimit + 12 })
                }, 'Last inn flere') : ''
            );
            
            wrapper.append(content);
            return wrapper;
        }

        // FIKS: La til manglende funksjon
        function renderDashboardHeader(theme) {
            const filterButton = createElement('button', {
                className: `px-4 py-2 rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover} font-semibold flex items-center gap-2`,
                onclick: e => {
                    e.stopPropagation();
                    const rect = e.currentTarget.getBoundingClientRect(); // <-- Hent posisjon F√òR setState
                    setState({ openCardMenu: { id: 'filter-menu', target: rect } }); // <-- Lagre rect i state
                }
            }, t(`filter.${state.filter}`), createElement('span', { innerHTML: icons.chevronDown('w-4 h-4') }));

            const searchFieldContainer = createElement('div', { className: `relative ${theme.textSecondary} flex-grow md:flex-grow-0` },
                createElement('span', { className: 'absolute left-3 top-1/2 -translate-y-1/2', innerHTML: icons.search('w-5 h-5') }),
                createElement('input', {
                    type: 'text',
                    placeholder: 'S√∏k etter kunde, adresse...',
                    className: `w-full md:w-64 pl-10 pr-4 py-2 rounded-lg border ${theme.border} ${theme.inputBg}`,
                    value: state.searchTerm,
                    oninput: e => setState({ searchTerm: e.target.value })
                })
            );

            const newProjectButton = createElement('button', {
                className: `px-4 py-2 rounded-lg ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText} ${theme.buttonPrimaryHover} font-semibold flex items-center gap-2 transition-all-smooth btn-interaction`,
                onclick: handleNewQuote
            }, createElement('span', { innerHTML: icons.plus('w-5 h-5') }), createElement('span', { className: 'hidden sm:inline' }, t('controls.new_quote')));

            // --- START ENDRING: Ny header-struktur ---
            return createElement('div', { className: 'flex flex-col md:flex-row md:items-center md:justify-between gap-4' }, 
                
                // NY VENSTRE/SENTRUM-BLOKK (Fleksibel)
                createElement('div', { className: 'flex-grow flex flex-col md:flex-row md:items-center gap-4' }, 
                    createElement('h2', { className: 'text-3xl font-bold flex-shrink-0' }, t('nav.quotes')), // Tittel
                    
                    // --- KONTROLLER FLYTTET HIT ---
                    filterButton,
                    searchFieldContainer
                ),
                
                // H√òYRE-BLOKK (Kun prim√¶rknapp)
                createElement('div', { className: 'flex-shrink-0' }, // Bruker flex-shrink-0 for √• sikre at den holder seg til h√∏yre
                    newProjectButton
                )
                // --- SLUTT ENDRING ---
            );
        }
        
        // FIKS: La til manglende funksjon
        function renderAnalyticsPage() {
            const theme = themes[state.theme];
            return createElement('div', { className: 'p-4 md:p-8' },
                createElement('h2', { className: 'text-3xl font-bold mb-6' }, 'Analyse'),
                createElement('p', { className: `${theme.textSecondary}` }, 'Denne modulen er under utvikling.')
            );
        }

        // FIKS: La til manglende funksjon
        function renderCalendarPage() {
            const theme = themes[state.theme];

            // --- FIKS: Sikrer at 'today' er et gyldig Date-objekt ---
            // Feilloggen indikerer at state.calendarViewDate noen ganger ikke er et Date-objekt.
            // Ved √• pakke den i new Date() sikrer vi at 'today' alltid har Date-metoder.
            const today = new Date(state.calendarViewDate); 
            // --- SLUTT P√Ö FIKS ---
            
            const monthName = today.toLocaleDateString('no-NO', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).getDay();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const dayOffset = (firstDay === 0) ? 6 : firstDay - 1; // Mandag=0, S√∏ndag=6

            const changeMonth = (offset) => {
                const newDate = new Date(today.getFullYear(), today.getMonth() + offset, 1);
                setState({ calendarViewDate: newDate });
            };

            const header = createElement('div', { className: 'flex justify-between items-center mb-6' },
                createElement('h2', { className: 'text-3xl font-bold' }, 'Kalender'),
                createElement('div', { className: 'flex items-center gap-4' },
                    createElement('span', { className: 'text-xl font-semibold capitalize' }, monthName),
                    createElement('div', { className: 'flex gap-2' },
                        createElement('button', { className: `p-2 ${theme.buttonSecondaryBg} rounded-lg`, innerHTML: icons.chevronLeft('w-5 h-5'), onclick: () => changeMonth(-1) }),
                        createElement('button', { className: `p-2 ${theme.buttonSecondaryBg} rounded-lg`, innerHTML: icons.chevronRight('w-5 h-5'), onclick: () => changeMonth(1) })
                    )
                )
            );

            const grid = createElement('div', { className: 'grid grid-cols-7 border-t border-l ' + theme.border });
            const weekdays = ['Man', 'Tir', 'Ons', 'Tor', 'Fre', 'L√∏r', 'S√∏n'];
            weekdays.forEach(day => {
                grid.append(createElement('div', { className: `p-2 text-center font-semibold text-sm ${theme.bg} border-b border-r ${theme.border}` }, day));
            });

            const projectsThisMonth = state.quotes.filter(q => {
                const d = new Date(q.installationDate);
                return d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear() && ['godk√§nd', 'genomf√∂rd', 'betald', 'p√•g√•r'].includes(q.status);
            });

            for (let i = 0; i < dayOffset; i++) {
                grid.append(createElement('div', { className: `h-32 ${theme.bg} border-b border-r ${theme.border}` }));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const cell = createElement('div', { className: `h-32 p-2 border-b border-r ${theme.border} relative overflow-y-auto` });
                cell.append(createElement('span', { className: 'font-semibold' }, day));
                
                const dayDate = new Date(today.getFullYear(), today.getMonth(), day);
                const projectsToday = projectsThisMonth.filter(p => new Date(p.installationDate).getDate() === day);
                
                projectsToday.forEach(p => {
                    const pill = createElement('div', { 
                        className: `text-xs p-1 rounded ${getStatusPillStyles(p.status, theme)} truncate mt-1 cursor-pointer`, 
                        title: p.customer,
                        onclick: () => setState({ selectedQuoteId: p.id, formData: { ...p } })
                    }, p.customer);
                    cell.append(pill);
                });
                
                grid.append(cell);
            }

            return createElement('div', { className: 'p-4 md:p-8' }, header, grid);
        }

        // FIKS: La til manglende funksjon
        const getFilteredQuotes = () => {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            let quotes = state.quotes;

            if (state.filter === 'prioriterade') {
                quotes = quotes.filter(q => ['utkast', 'f√∂rslag-skickat', 'godk√§nd'].includes(q.status));
            } else if (state.filter === 'aktiva') {
                quotes = quotes.filter(q => ['f√∂rslag-skickat', 'godk√§nd', 'genomf√∂rd', 'p√•g√•r'].includes(q.status));
            } else if (state.filter === 'kommande') {
                quotes = quotes.filter(q => q.installationDate >= today && q.installationDate <= nextWeek && ['godk√§nd', 'p√•g√•r'].includes(q.status));
            }
            
            if (state.searchTerm) {
                const term = state.searchTerm.toLowerCase();
                quotes = quotes.filter(q => 
                    q.customer.toLowerCase().includes(term) || 
                    q.address.toLowerCase().includes(term) || 
                    q.id.toLowerCase().includes(term)
                );
            }
            
            return quotes.sort((a, b) => new Date(a.installationDate) - new Date(b.installationDate));
        };
        
        // FIKS: La til manglende funksjon
        function renderNavigation(theme) {
            const isNavCollapsed = state.isNavCollapsed; // <-- H√ÑMTA STATE
            const navItems = [
                { id: 'quotes', icon: icons.quotes, label: t('nav.quotes') },
                { id: 'projects', icon: icons.projects, label: t('nav.projects') },
                { id: 'calendar', icon: icons.calendar, label: t('nav.calendar') },
                { id: 'products', icon: icons.products, label: t('nav.products') },
                { id: 'suppliers', icon: icons.suppliers, label: t('nav.suppliers') },
                { id: 'time_reporting', icon: icons.time, label: t('nav.time_reporting') },
                { id: 'socials', icon: icons.socials, label: t('nav.socials') },
                { id: 'analytics', icon: icons.analytics, label: t('nav.analytics') },
                { id: 'wishlist', icon: icons.wishlist, label: t('nav.wishlist') },
                { id: 'staff', icon: icons.staff, label: t('nav.staff') },
            ];

            const createNavItem = (item) => {
                const isActive = state.activeView === item.id;
                return createElement('a', {
                    href: '#',
                    className: `flex items-center gap-3 px-4 py-3 rounded-lg font-semibold transition-all-smooth overflow-hidden whitespace-nowrap ${isActive ? theme.navActive : theme.navInactive} ${isNavCollapsed ? 'justify-center' : ''}`, // <-- MODIFISERT
                    onclick: () => setState({ activeView: item.id })
                }, createElement('div', { innerHTML: item.icon(`w-6 h-6 ${isActive ? '' : theme.textSecondary}`) }), createElement('span', { className: `font-semibold overflow-hidden transition-all duration-200 ${isNavCollapsed ? 'opacity-0 w-0' : 'opacity-100 w-auto'}` }, item.label)); // <-- MODIFISERT
            };

            const sidebar = createElement('div', { className: `${isNavCollapsed ? 'w-20' : 'w-64'} ${theme.cardBg} border-r ${theme.border} h-screen flex flex-col flex-shrink-0 transition-all duration-300 ease-in-out` }, // <-- MODIFISERT
                createElement('div', { className: 'p-4 flex items-center justify-between' },  // <-- MODIFISERT
                    createElement('h1', { className: `text-2xl font-bold ${theme.accent} overflow-hidden whitespace-nowrap` }, 
                        createElement('span', { className: `transition-opacity duration-200 ${isNavCollapsed ? 'opacity-0' : 'opacity-100'}` }, 'Prima Portal') // <-- MODIFISERT
                    ),
                    createElement('button', { // <-- NY KNAPP
                        className: `p-1 rounded ${theme.buttonSecondaryHover} flex-shrink-0`,
                        onclick: () => setState({ isNavCollapsed: !isNavCollapsed })
                    }, createElement('div', { innerHTML: isNavCollapsed ? icons.chevronRight('w-5 h-5') : icons.chevronLeft('w-5 h-5') }))
                ),
                createElement('nav', { className: 'flex-grow p-4 space-y-2 overflow-y-auto' }, ...navItems.map(createNavItem)),
                createElement('div', { className: `p-4 border-t ${theme.border} space-y-2` },
                    createElement('button', {
                        className: `w-full flex items-center gap-3 px-4 py-3 rounded-lg ${theme.buttonSecondaryBg} ${theme.buttonSecondaryHover} overflow-hidden whitespace-nowrap ${isNavCollapsed ? 'justify-center' : ''}`, // <-- MODIFISERT
                        onclick: () => {
                            const newTheme = state.theme === 'light' ? 'dark' : 'light';
                            localStorage.setItem('prima-theme', newTheme);
                            document.documentElement.classList.toggle('dark', newTheme === 'dark');
                            setState({ theme: newTheme });
                        }
                    }, 
                    createElement('span', { className: `font-semibold overflow-hidden transition-all duration-200 ${isNavCollapsed ? 'opacity-0 w-0' : 'opacity-100 w-auto'} flex-grow text-left` }, state.theme === 'light' ? 'M√∏rkt modus' : 'Lyst modus'), // <-- MODIFISERT
                    createElement('div', { innerHTML: state.theme === 'light' ? icons.moon('w-5 h-5') : icons.sun('w-5 h-5') })
                    ),
                    createElement('button', {
                        className: `w-full flex items-center gap-3 px-4 py-3 rounded-lg font-semibold ${theme.navInactive} overflow-hidden whitespace-nowrap ${isNavCollapsed ? 'justify-center' : ''}`, // <-- MODIFISERT
                        onclick: () => setState({ isLoggedIn: false })
                    }, createElement('div', { innerHTML: icons.logout('w-6 h-6 ' + theme.textSecondary) }), createElement('span', { className: `font-semibold overflow-hidden transition-all duration-200 ${isNavCollapsed ? 'opacity-0 w-0' : 'opacity-100 w-auto'}` }, 'Logg ut')) // <-- MODIFISERT
                )
            );
            return sidebar;
        }

        // FIKS: La til manglende funksjon
        function renderLogin() {
            const theme = themes[state.theme];
            return createElement('div', { className: `min-h-screen flex items-center justify-center ${theme.bg} p-4` },
                createElement('div', { 
                    className: `w-full max-w-sm ${theme.cardBg} p-8 rounded-2xl shadow-xl border ${theme.border} animate-fade-in-scale`
                },
                    createElement('h1', { className: `text-3xl font-bold text-center mb-2 ${theme.accent}` }, 'Prima Portal'),
                    createElement('p', { className: `text-center ${theme.textSecondary} mb-6` }, t('login.welcome')),
                    createElement('button', {
                        id: 'login-button',
                        className: `w-full px-4 py-3 rounded-lg ${theme.buttonPrimaryBg} ${theme.buttonPrimaryText} ${theme.buttonPrimaryHover} font-semibold text-lg transition-all-smooth btn-interaction`,
                        onclick: () => setState({ isLoggedIn: true })
                    }, t('login.button'))
                )
            );
        }

        // FIKS: document.body.addEventListener var avklippet och manglet lukkefunksjoner
        document.body.addEventListener('click', (e) => {
            // LAGT TILL #modal-project-linker-menu
            const menusToClose = document.querySelectorAll('#global-card-status-menu, #global-filter-status-menu, #menu-template-popup, .project-status-menu, #modal-product-search-menu, #modal-project-linker-menu');
             let clickedOnMenuButton = e.target.closest('button'); 
 
             let shouldClose = true;
             if(clickedOnMenuButton){
                  const clickFn = clickedOnMenuButton.onclick?.toString();
                 // LAGT TILL modal-project-linker-menu
                 if(clickFn && (clickFn.includes('global-card-status-menu') || clickFn.includes('global-filter-status-menu') || clickFn.includes('menu-template-popup') || clickFn.includes('project-status-menu') || clickFn.includes('modal-product-search-menu') || clickFn.includes('modal-project-linker-menu'))){ 
                     shouldClose = false;
                  }
             }
             // FIKS: Denne delen manglet
             if(shouldClose) {
                menusToClose.forEach(menu => menu.remove());
                
                // --- FIX: START ---
                // Also update state if we are closing a modal menu
                if (state.isModalStatusOpen) {
                    setState({ isModalStatusOpen: false, modalStatusMenuTarget: null }, { render: false });
                }
                // Also close card menu state
                if (state.openCardMenu.id) {
                    setState({ openCardMenu: { id: null, target: null } }, { render: false });
                }
                // --- FIX: END ---
             }
        });

        // FIKS: Hele resten av filen manglet
        function renderApp() {
            const theme = themes[state.theme];
            appRoot.innerHTML = '';
            appRoot.className = `${theme.text} ${theme.bg}`;
            
            if (!state.isLoggedIn) {
                appRoot.append(renderLogin());
                return;
            }
            
            let mainContent;
            switch (state.activeView) {
                case 'quotes': mainContent = renderQuotesPage(theme); break;
                case 'projects': mainContent = renderProjectsPage(); break;
                case 'suppliers': mainContent = renderSuppliersPage(); break;
                case 'products': mainContent = renderProductsPage(); break;
                case 'time_reporting': mainContent = renderTimeReportingPage(); break;
                case 'socials': mainContent = renderSocialsPage(); break;
                case 'analytics': mainContent = renderAnalyticsPage(); break;
                case 'calendar': mainContent = renderCalendarPage(); break;
                case 'wishlist': mainContent = renderWishlistPage(); break;
                case 'staff': mainContent = renderStaffPage(); break;
                default: mainContent = renderQuotesPage(theme);
            }
            
            const layout = createElement('div', { className: 'flex h-screen' },
                renderNavigation(theme),
                createElement('main', { className: 'flex-grow h-screen overflow-y-auto' }, mainContent)
            );
            appRoot.append(layout);

            if (state.selectedQuoteId) {
                appRoot.append(renderModal(state.selectedQuoteId));
                // --- FIX: START ---
                // DO NOT render the status changer here. It is now handled manually by the button inside renderModal.
                // if(state.isModalStatusOpen) appRoot.append(renderGlobalStatusChanger(state.modalStatusMenuTarget)); // <-- MODIFISERT
                // --- FIX: END ---
            }
            if (state.openCardMenu && state.openCardMenu.id && state.openCardMenu.target) {
                if (state.openCardMenu.id === 'filter-menu') {
                    appRoot.append(renderFilterStatusMenu(state.openCardMenu.target));
                } else {
                    const quote = state.quotes.find(q => q.id === state.openCardMenu.id);
                    if(quote) appRoot.append(renderCardStatusMenu(quote, state.openCardMenu.target));
                }
            }
            if (state.isTimePickerOpen) appRoot.append(renderTimePicker());
            if (state.isConfirmModalOpen) appRoot.append(renderConfirmModal());
            if (state.isDeleteConfirmModalOpen) appRoot.append(renderDeleteConfirmModal());
            if (state.simulatedEmailQuote) appRoot.append(renderEmailSimulation(state.simulatedEmailQuote));
            if (state.isTemplateEditorOpen) appRoot.append(renderTemplateEditor());
            if (state.productToEdit) appRoot.append(renderProductModal());
            if (state.isDeleteProductConfirmOpen) appRoot.append(renderDeleteProductConfirmModal());
            // --- NYA MODAL-ANROP F√ñR ANSATTE ---
            if (state.staffToEdit) appRoot.append(renderStaffModal());
            if (state.isDeleteStaffConfirmModalOpen) appRoot.append(renderDeleteStaffConfirmModal());
            
            // --- START SURGICAL MODIFICATION 4 (Render Call) ---
            // Legg til anrop for den nye prosjektmodalen
            if (state.selectedProjectId) appRoot.append(renderProjectDetailModal());
            // --- END SURGICAL MODIFICATION 4 ---

            // --- START NY RENDER CALL FOR KOLONNE-EDITOR ---
            if (state.isEditingColumn) appRoot.append(renderProjectColumnEditorModal());
            // --- SLUTT NY RENDER CALL ---
        }

        // REPLACED old DOMContentLoaded with new async handler
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Prima Portal initializing...');
        
            // Initialize theme first (immediate visual feedback)
            const savedTheme = localStorage.getItem('prima-theme') || 'light';
            state.theme = savedTheme;
            document.documentElement.classList.toggle('dark', savedTheme === 'dark');
        
            // Show loading state
            renderFallback();
        
            // Load PDF libraries in background
            const pdfReady = await initializePDFLibraries();
        
            // Continue with rest of initialization
            const savedTemplates = localStorage.getItem('prima-product-templates');
            try {
                if (savedTemplates) {
                    state.productTemplates = JSON.parse(savedTemplates);
                } else {
                    state.productTemplates = defaultProductTemplates;
                }
            } catch (e) {
                console.error("Kunne ikke laste produktmaler:", e);
                state.productTemplates = defaultProductTemplates;
            }
        
            // Load user votes
            const savedVotes = localStorage.getItem('prima-user-votes');
            if (savedVotes) {
                try {
                     state.userVotes = JSON.parse(savedVotes);
                 } catch (e) {
                     console.error('Could not parse user votes', e);
                     state.userVotes = {};
                 }
            }
            
            // Load quotes
            try {
                const quotesData = await dataService.getQuotes();
                // 5. BOOTSTRAP: transformN8nQuoteToPortalQuote avl√§gsnar nu projectStatus
                state.quotes = quotesData.map(transformN8nQuoteToPortalQuote); 
                
                // --- 5. BOOTSTRAP: Extrahera Projekt fr√•n Tilbud ---
                const projectsMap = new Map();
                // Vi m√•ste titta p√• originaldatan (quotesData) f√∂r att hitta projektstatusen
                quotesData.forEach(originalQuote => {
                    const projectStatus = originalQuote.projectStatus || 'nytt';
                    const projectId = originalQuote.projectId;
                    
                    if (!projectId) return; // Hoppa √∂ver tilbud utan projekt-ID

                    if (!projectsMap.has(projectId)) {
                        // F√∂rsta g√•ngen vi ser detta projekt
                        projectsMap.set(projectId, {
                            projectId: projectId,
                            projectStatus: projectStatus,
                            customerName: originalQuote.customer, // Anv√§nd info fr√•n detta tilbud
                            address: originalQuote.address,
                            quoteIds: [originalQuote.id]
                        });
                    } else {
                        // Projektet finns, l√§gg till tilbuds-ID
                        const existingProject = projectsMap.get(projectId);
                        existingProject.quoteIds.push(originalQuote.id);
                        
                        // Prioriteringslogik f√∂r status: 'p√•g√•r' > 'planlagt' > 'nytt'
                        const statusPriority = { 'fullf√∏rt': 4, 'p√•g√•r': 3, 'planlagt': 2, 'nytt': 1 };
                        const currentPriority = statusPriority[existingProject.projectStatus] || 1;
                        const newPriority = statusPriority[projectStatus] || 1;
                        
                        // Om det nya tilbudet har en h√∂gre status, uppdatera projektets status
                        if (newPriority > currentPriority) {
                            existingProject.projectStatus = projectStatus;
                        }
                        // Uppdatera √§ven kundinfo om det saknades
                        if (!existingProject.customerName && originalQuote.customer) {
                            existingProject.customerName = originalQuote.customer;
                        }
                    }
                });
                state.projects = Array.from(projectsMap.values());
                // --- SLUTT P√Ö PROJEKT-EXTRAHERING ---
                
            } catch (error) {
                console.error("Feil ved henting av prosjekter:", error);
                if (error.message === 'NetworkError') {
                    showToast('Nettverksfeil. Kunne ikke laste prosjekter.', 'error');
                } else {
                    showToast('En feil oppstod. ' + error.message, 'error');
                }
            } finally {
                state.isLoading = false;
            }

            // Resize handler
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    if (state.activeView === 'calendar') {
                        renderApp();
                    }
                }, 250);
            });
            console.log(`‚úÖ Prima Portal ready ${pdfReady ? 'with PDF' : 'without PDF'}`);
            renderApp();
        });

    </script>
</body>
</html>
